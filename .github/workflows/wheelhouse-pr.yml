name: Create Wheelhouse PR

on:
  workflow_run:
    workflows: ["Build wheels"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      run_id:
        description: '(optional) Build wheels workflow run id to download artifacts from'
        required: false

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  create-wheelhouse-pr:
    name: Create PR with wheelhouse
    # Allow this job to run when triggered by a successful workflow_run OR when manually dispatched
    if: ${{ (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') || (github.event_name == 'workflow_dispatch') }}
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Determine build run id
        id: determine_run
        run: |
          # If triggered by workflow_run, use that id
          if [ "${GITHUB_EVENT_NAME}" = "workflow_run" ]; then
            echo "RUN_ID=${{ github.event.workflow_run.id }}" >> $GITHUB_ENV
            echo "Determined RUN_ID from workflow_run: ${{ github.event.workflow_run.id }}"
            exit 0
          fi

          # If manual trigger and explicit input run_id provided, use it
          # (workflow_dispatch inputs can be referenced as github.event.inputs)
          MANUAL_RUN_ID="${{ github.event.inputs.run_id || '' }}"
          if [ -n "$MANUAL_RUN_ID" ]; then
            echo "RUN_ID=$MANUAL_RUN_ID" >> $GITHUB_ENV
            echo "Determined RUN_ID from workflow_dispatch input: $MANUAL_RUN_ID"
            exit 0
          fi

          # Otherwise query the Actions API for the latest successful Build wheels run
          OWNER_REPO="${GITHUB_REPOSITORY}"
          OWNER="$(echo "$OWNER_REPO" | cut -d'/' -f1)"
          REPO="$(echo "$OWNER_REPO" | cut -d'/' -f2)"
          WORKFLOW_FILE="maturin-build.yml"

          echo "Querying GitHub API for latest successful run of $WORKFLOW_FILE..."
          resp=$(curl -s -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${OWNER}/${REPO}/actions/workflows/${WORKFLOW_FILE}/runs?status=completed&conclusion=success&per_page=1")

          # Parse run id (requires jq)
          if command -v jq > /dev/null; then
            run_id=$(echo "$resp" | jq -r '.workflow_runs[0].id // empty')
          else
            # Fallback to python parsing if jq not available
            run_id=$(python - <<'PY'
            import sys, json
            data = json.load(sys.stdin)
            runs = data.get("workflow_runs") or []
            print(runs[0].get("id") if runs else "")
            PY
            <<<"$resp")
          fi

          if [ -z "$run_id" ]; then
            echo "ERROR: Could not find a successful Build wheels run. Provide run_id as workflow_dispatch input or ensure Build wheels ran successfully." >&2
            exit 1
          fi

          echo "RUN_ID=$run_id" >> $GITHUB_ENV
          echo "Determined RUN_ID from API: $run_id"

      - name: Set run URL
        run: |
          # If triggered by workflow_run we can use the provided html_url, otherwise construct a run URL from RUN_ID
          if [ "${GITHUB_EVENT_NAME}" = "workflow_run" ]; then
            echo "RUN_URL=${{ github.event.workflow_run.html_url }}" >> $GITHUB_ENV
            echo "Determined RUN_URL from workflow_event: ${{ github.event.workflow_run.html_url }}"
          else
            echo "RUN_URL=https://github.com/${GITHUB_REPOSITORY}/actions/runs/${RUN_ID}" >> $GITHUB_ENV
            echo "Constructed RUN_URL: https://github.com/${GITHUB_REPOSITORY}/actions/runs/${RUN_ID}"
          fi

      - name: Download wheelhouse artifacts
        uses: actions/download-artifact@v4
        with:
          name: wheelhouse
          path: wheelhouse-temp
          run-id: ${{ env.RUN_ID }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download release archives
        uses: actions/download-artifact@v4
        with:
          name: release-archives
          path: .
          run-id: ${{ env.RUN_ID }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Ensure wheelhouse artifact present
        run: |
          set -euo pipefail
          # If wheelhouse-temp already exists (download-artifact succeeded), we're good
          if [ -d "wheelhouse-temp" ]; then
            echo "Found wheelhouse-temp from artifacts."
            exit 0
          fi

          # If wheelhouse.zip exists, try to extract it
          if [ -f "wheelhouse.zip" ]; then
            echo "wheelhouse.zip found â€” extracting..."
            mkdir -p extracted
            unzip -q wheelhouse.zip -d extracted || true
            # Prefer a top-level 'wheelhouse' directory if present
            if [ -d "extracted/wheelhouse" ]; then
              mv extracted/wheelhouse wheelhouse-temp
            else
              mkdir -p wheelhouse-temp
              mv extracted/* wheelhouse-temp || true
            fi
            rm -rf extracted
          fi

          # If wheelhouse.tar.gz exists, try to extract it
          if [ -f "wheelhouse.tar.gz" ]; then
            echo "wheelhouse.tar.gz found â€” extracting..."
            mkdir -p extracted
            tar -xzf wheelhouse.tar.gz -C extracted || true
            if [ -d "extracted/wheelhouse" ]; then
              mv extracted/wheelhouse wheelhouse-temp
            else
              mkdir -p wheelhouse-temp
              mv extracted/* wheelhouse-temp || true
            fi
            rm -rf extracted
          fi

          # Final check
          if [ -d "wheelhouse-temp" ]; then
            echo "wheelhouse-temp prepared."
            ls -la wheelhouse-temp | sed -n '1,200p'
          else
            echo "ERROR: wheelhouse artifact not found. Available files in workspace:" >&2
            ls -la
            exit 1
          fi
          
      - name: Prepare wheelhouse directory
        run: |
          # Remove old wheelhouse if it exists
          rm -rf wheelhouse
          
          # Move the new wheelhouse into place
          mv wheelhouse-temp wheelhouse
          
          # Remove large binaries to avoid exceeding GitHub push limits
          # Delete any wheel/tar/zip files >100MB (GitHub limit)
          find wheelhouse -type f \( -name '*.whl' -o -name '*.tar.gz' -o -name '*.zip' \) -size +100M -print -delete || true
          # Also remove top-level archives if present
          rm -f wheelhouse.tar.gz wheelhouse.zip || true
          
          # Create a README for the wheelhouse
          cat > wheelhouse/README.md << 'EOF'
          # Wheelhouse

          This directory contains pre-built wheel packages for all supported platforms.

          ## Installation

          To install a wheel for your platform, use:

          ```bash
          pip install wheelhouse/<wheel-file-for-your-platform>.whl
          ```

          ## Platform-specific Requirements

          - **Linux AMD64**: See `requirements-linux-amd64.txt`
          - **Linux ARM64**: See `requirements-linux-aarch64.txt`
          - **macOS x86_64**: See `requirements-macos-x86_64.txt`
          - **macOS ARM64**: See `requirements-macos-arm64.txt`
          - **Windows AMD64**: See `requirements-windows-amd64.txt`
          - **Windows ARM64**: See `requirements-windows-arm64.txt`

          ## Verification

          All files include SHA256 checksums. To verify:

          ```bash
          sha256sum -c wheelhouse/<file>.sha256
          ```

          Or check against the master list in `CHECKSUMS.sha256`.

          ## Build Information

          - Build Date: $(date -u)
          - Workflow Run: ${{ github.event.workflow_run.id }}
          - Commit: ${{ github.event.workflow_run.head_sha }}
          EOF
          
          # Add .gitattributes to mark wheels as binary
          cat > wheelhouse/.gitattributes << 'EOF'
          *.whl binary
          *.tar.gz binary
          *.zip binary
          EOF

      - name: Commit wheelhouse into repo branch using Git LFS
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "Installing git-lfs..."
          sudo apt-get update
          sudo apt-get install -y git-lfs || true
          git lfs install --local

          echo "Configuring git user..."
          git config user.email "actions@github.com"
          git config user.name "github-actions[bot]"

          echo "Preparing branch 'build' from origin/main..."
          git fetch origin main --depth=1
          git checkout -B build origin/main

          echo "Ensure wheelhouse directory exists..."
          if [ ! -d "wheelhouse" ]; then
            echo "ERROR: wheelhouse directory not present" >&2
            ls -la
            exit 1
          fi

          echo "Create .gitattributes for LFS tracking and add it"
          cat > .gitattributes <<'EOF'
          *.whl filter=lfs diff=lfs merge=lfs -text
          *.tar.gz filter=lfs diff=lfs merge=lfs -text
          *.zip filter=lfs diff=lfs merge=lfs -text
          EOF
          git add .gitattributes

          echo "Track file patterns with git-lfs (local)"
          git lfs track "*.whl" || true
          git lfs track "*.tar.gz" || true
          git lfs track "*.zip" || true
          git add .gitattributes

          # wheelhouse is already in the repository workspace root (moved earlier)
          echo "Using wheelhouse directory present in workspace for commit."

          echo "Add files (LFS will handle large files)"
          git add -A wheelhouse

          COMMIT_MSG="chore: add/update wheelhouse artifacts for run ${RUN_ID}"
          if git diff --cached --quiet; then
            echo "No changes to commit (wheelhouse unchanged)"
          else
            git commit -m "${COMMIT_MSG}"
          fi

          echo "Push branch to origin (try safe --force-with-lease first)"
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          if git push --force-with-lease origin build:refs/heads/build; then
            echo "Pushed with --force-with-lease"
          else
            echo "Warning: --force-with-lease failed (stale remote). Falling back to --force push."
            git fetch origin build || true
            git push --force origin build:refs/heads/build
          fi
      - name: Create or update Pull Request (build â†’ develop)
        id: create_or_update_pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          OWNER_REPO="${GITHUB_REPOSITORY}"
          OWNER="$(echo "$OWNER_REPO" | cut -d'/' -f1)"
          REPO="$(echo "$OWNER_REPO" | cut -d'/' -f2)"
          HEAD_BRANCH="build"
          BASE_BRANCH="develop"
          TITLE="ðŸŽ¡ Update Wheelhouse - Build #${RUN_ID}"
          BODY="This PR updates the wheelhouse metadata for build run ${RUN_ID}.\n\nArtifacts and full wheels are in the 'build' branch (LFS-managed). Action run: ${ARTIFACTS_URL}"

          echo "Checking for an existing open PR from ${HEAD_BRANCH} to ${BASE_BRANCH}..."
          existing_pr=$(curl -s -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${OWNER}/${REPO}/pulls?head=${OWNER}:${HEAD_BRANCH}&base=${BASE_BRANCH}&state=open" | jq -r '.[0].number // empty')

          if [ -n "$existing_pr" ]; then
            echo "Found existing PR #$existing_pr â€” updating title/body"
            curl -s -X PATCH -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" \
              -d "$(jq -n --arg t "$TITLE" --arg b "$BODY" '{title:$t, body:$b}')" \
              "https://api.github.com/repos/${OWNER}/${REPO}/pulls/${existing_pr}"
            echo "PR_UPDATED=${existing_pr}" >> $GITHUB_ENV
          else
            echo "No existing PR â€” creating a new PR from ${HEAD_BRANCH} to ${BASE_BRANCH}"
            pr_resp=$(curl -s -X POST -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" \
              -d "$(jq -n --arg head "$HEAD_BRANCH" --arg base "$BASE_BRANCH" --arg title "$TITLE" --arg body "$BODY" '{head:$head, base:$base, title:$title, body:$body}')" \
              "https://api.github.com/repos/${OWNER}/${REPO}/pulls")
            pr_number=$(echo "$pr_resp" | jq -r '.number // empty')
            if [ -z "$pr_number" ]; then
              echo "ERROR: failed to create PR" >&2
              echo "Response: $pr_resp"
              exit 1
            fi
            echo "PR_CREATED=${pr_number}" >> $GITHUB_ENV
          fi

      - name: Add PR comment with instructions
        if: ${{ env.PR_CREATED || env.PR_UPDATED || always() }}
        run: |
          set -euo pipefail
          # prefer PR number from env (created or updated)
          PR_NUM="${PR_CREATED:-${PR_UPDATED:-}}"

          if [ -z "$PR_NUM" ]; then
            # fetch PR number robustly (use Python to handle array/object responses)
            resp=$(curl -s -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls?head=${GITHUB_REPOSITORY%/*}:build&base=develop&state=open")
            PR_NUM=$(python - <<'PY'
            import sys, json
            try:
                d = json.load(sys.stdin)
            except Exception:
                print("")
                sys.exit(0)
            if isinstance(d, list):
                print(d[0].get("number","") if d else "")
            elif isinstance(d, dict):
                # API may return single object or paginated structure
                if "number" in d:
                    print(d.get("number",""))
                elif "items" in d and isinstance(d["items"], list) and d["items"]:
                    print(d["items"][0].get("number",""))
                else:
                    print("")
            else:
                print("")
            PY
            <<<"$resp")
                      fi

                      if [ -z "$PR_NUM" ]; then
                        echo "No PR found to comment on." >&2
                        exit 0
                      fi

          COMMENT_BODY="$(cat <<'EOF'
          ## ðŸ“¦ Installation Instructions

          This PR includes the wheelhouse files in branch `build`. Large binaries are stored with Git LFS.

          To get the artifacts:

          ```bash
          # Clone and fetch LFS objects
          git clone --branch build https://github.com/${GITHUB_REPOSITORY}.git
          cd $(basename ${GITHUB_REPOSITORY})
          git lfs pull
          pip install wheelhouse/<appropriate-wheel-file>.whl
          ```

          Or download artifacts directly from the Actions run:
          ${ARTIFACTS_URL}
          EOF
          )"

          curl -s -X POST -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" \
            -d "$(jq -n --arg body "$COMMENT_BODY" '{body:$body}')" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/${PR_NUM}/comments"
