name: Create Wheelhouse PR

on:
  workflow_run:
    workflows: ["Build wheels"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      run_id:
        description: '(optional) Build wheels workflow run id to download artifacts from'
        required: false

permissions:
  contents: write
  pull-requests: write
  actions: read
  id-token: write  # Required for attestations

jobs:
  create-wheelhouse-pr:
    name: Create PR with wheelhouse
    # Allow this job to run when triggered by a successful workflow_run OR when manually dispatched
    if: ${{ (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') || (github.event_name == 'workflow_dispatch') }}
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: develop

      - name: Determine build run id
        id: determine_run
        run: |
          # If triggered by workflow_run, use that id
          if [ "${GITHUB_EVENT_NAME}" = "workflow_run" ]; then
            echo "RUN_ID=${{ github.event.workflow_run.id }}" >> $GITHUB_ENV
            echo "Determined RUN_ID from workflow_run: ${{ github.event.workflow_run.id }}"
            exit 0
          fi

          # If manual trigger and explicit input run_id provided, use it
          # (workflow_dispatch inputs can be referenced as github.event.inputs)
          MANUAL_RUN_ID="${{ github.event.inputs.run_id || '' }}"
          if [ -n "$MANUAL_RUN_ID" ]; then
            echo "RUN_ID=$MANUAL_RUN_ID" >> $GITHUB_ENV
            echo "Determined RUN_ID from workflow_dispatch input: $MANUAL_RUN_ID"
            exit 0
          fi

          # Otherwise query the Actions API for the latest successful Build wheels run
          OWNER_REPO="${GITHUB_REPOSITORY}"
          OWNER="$(echo "$OWNER_REPO" | cut -d'/' -f1)"
          REPO="$(echo "$OWNER_REPO" | cut -d'/' -f2)"
          WORKFLOW_FILE="maturin-build.yml"

          echo "Querying GitHub API for latest successful run of $WORKFLOW_FILE..."
          resp=$(curl -s -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${OWNER}/${REPO}/actions/workflows/${WORKFLOW_FILE}/runs?status=completed&conclusion=success&per_page=1")

          # Parse run id (requires jq)
          if command -v jq > /dev/null; then
            run_id=$(echo "$resp" | jq -r '.workflow_runs[0].id // empty')
          else
            # Fallback to python parsing if jq not available
            run_id=$(python - <<'PY'
            import sys, json
            data = json.load(sys.stdin)
            runs = data.get("workflow_runs") or []
            print(runs[0].get("id") if runs else "")
            PY
            <<<"$resp")
          fi

          if [ -z "$run_id" ]; then
            echo "ERROR: Could not find a successful Build wheels run. Provide run_id as workflow_dispatch input or ensure Build wheels ran successfully." >&2
            exit 1
          fi

          echo "RUN_ID=$run_id" >> $GITHUB_ENV
          echo "Determined RUN_ID from API: $run_id"

      - name: Set run URL
        run: |
          # If triggered by workflow_run we can use the provided html_url, otherwise construct a run URL from RUN_ID
          if [ "${GITHUB_EVENT_NAME}" = "workflow_run" ]; then
            echo "RUN_URL=${{ github.event.workflow_run.html_url }}" >> $GITHUB_ENV
            echo "Determined RUN_URL from workflow_event: ${{ github.event.workflow_run.html_url }}"
          else
            echo "RUN_URL=https://github.com/${GITHUB_REPOSITORY}/actions/runs/${RUN_ID}" >> $GITHUB_ENV
            echo "Constructed RUN_URL: https://github.com/${GITHUB_REPOSITORY}/actions/runs/${RUN_ID}"
          fi

      - name: Download wheelhouse artifacts
        uses: actions/download-artifact@v4
        with:
          name: wheelhouse
          path: wheelhouse-temp
          run-id: ${{ env.RUN_ID }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download release archives
        uses: actions/download-artifact@v4
        with:
          name: release-archives
          path: release-archives
          run-id: ${{ env.RUN_ID }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Ensure wheelhouse artifact present
        run: |
          set -euo pipefail
          # If wheelhouse-temp already exists (download-artifact succeeded), we're good
          if [ -d "wheelhouse-temp" ]; then
            echo "Found wheelhouse-temp from artifacts."
            exit 0
          fi

          # If wheelhouse.zip exists, try to extract it
          if [ -f "wheelhouse.zip" ]; then
            echo "wheelhouse.zip found ‚Äî extracting..."
            mkdir -p extracted
            unzip -q wheelhouse.zip -d extracted || true
            # Prefer a top-level 'wheelhouse' directory if present
            if [ -d "extracted/wheelhouse" ]; then
              mv extracted/wheelhouse wheelhouse-temp
            else
              mkdir -p wheelhouse-temp
              mv extracted/* wheelhouse-temp || true
            fi
            rm -rf extracted
          fi

          # If wheelhouse.tar.gz exists, try to extract it
          if [ -f "wheelhouse.tar.gz" ]; then
            echo "wheelhouse.tar.gz found ‚Äî extracting..."
            mkdir -p extracted
            tar -xzf wheelhouse.tar.gz -C extracted || true
            if [ -d "extracted/wheelhouse" ]; then
              mv extracted/wheelhouse wheelhouse-temp
            else
              mkdir -p wheelhouse-temp
              mv extracted/* wheelhouse-temp || true
            fi
            rm -rf extracted
          fi

          # Final check
          if [ -d "wheelhouse-temp" ]; then
            echo "wheelhouse-temp prepared."
            ls -la wheelhouse-temp | sed -n '1,200p'
          else
            echo "ERROR: wheelhouse artifact not found. Available files in workspace:" >&2
            ls -la
            exit 1
          fi
          
      - name: Prepare wheelhouse directory
        run: |
          # Remove old wheelhouse if it exists
          rm -rf wheelhouse
          
          # Move the new wheelhouse into place
          mv wheelhouse-temp wheelhouse
          
          # Clean up any junk files - keep only wheels, tar.gz, and checksums
          find wheelhouse -type f ! \( -name "*.whl" -o -name "*.tar.gz" -o -name "*.sha256" -o -name "CHECKSUMS.sha256" \) -delete 2>/dev/null || true
          
          # Remove files over 100MB (GitHub's limit)
          find wheelhouse -type f -size +100M -exec rm {} \;
          
          echo "Wheelhouse contents:"
          ls -lah wheelhouse/

      - name: Merge release archives into wheelhouse
        run: |
          set -euo pipefail
          if [ -d "release-archives" ]; then
            mkdir -p wheelhouse
            shopt -s nullglob
            for file in release-archives/*.tar.gz release-archives/*.tar.gz.sha256; do
              cp "$file" wheelhouse/ 2>/dev/null || true
            done
            if [ -f "release-archives/CHECKSUMS.sha256" ]; then
              cp release-archives/CHECKSUMS.sha256 wheelhouse/
            fi
            echo "Wheelhouse merged contents:"
            ls -lah wheelhouse/
          else
            echo "release-archives artifact not found; skipping merge."
          fi

      - name: Commit wheelhouse into repo branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          echo "Configuring git..."
          git config user.email "actions@github.com"
          git config user.name "github-actions[bot]"
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          
          # Define commit message
          COMMIT_MSG="Update wheelhouse from build run ${RUN_ID}"
          
          # Save wheelhouse contents to temp location before switching branches
          echo "Saving wheelhouse to temp location..."
          cp -r wheelhouse /tmp/wheelhouse-save
          
          # Verify the files are actually there and are real wheel files
          echo "Contents of /tmp/wheelhouse-save (showing file sizes):"
          ls -lh /tmp/wheelhouse-save/ 2>/dev/null | head -20
          
          echo "Fetching branches..."
          git fetch origin
          
          echo "Switching to build branch..."
          git checkout -B build origin/develop
          
          # Clean out the old wheelhouse completely
          echo "Cleaning old wheelhouse directory..."
          rm -rf wheelhouse
          mkdir -p wheelhouse
          
          # Copy ALL files from the saved wheelhouse
          echo "Copying NEW wheelhouse files from temp location..."
          cp -rv /tmp/wheelhouse-save/* wheelhouse/
          
          # Show what we have
          echo "New wheelhouse contents:"
          ls -lh wheelhouse/ | head -20
          
          # Stage all changes (deletions and additions)
          echo "Staging all wheelhouse changes..."
          git add wheelhouse/
          
          echo "Checking staged files..."
          STAGED_COUNT=$(git diff --cached --name-only | wc -l)
          echo "Number of staged files: $STAGED_COUNT"
          
          if [ "$STAGED_COUNT" -gt 0 ]; then
            echo "Staged files:"
            git diff --cached --name-only
            echo ""
            echo "File size changes:"
            git diff --cached --stat
          else
            # If no changes, it might mean files are identical
            echo "No changes detected. Checking if files already exist..."
            ls -lh wheelhouse/*.whl 2>/dev/null | head -5 || echo "No wheel files found!"
            
            # Force add to make sure
            echo "Force adding wheelhouse files..."
            git add -f wheelhouse/
            STAGED_COUNT=$(git diff --cached --name-only | wc -l)
            
            if [ "$STAGED_COUNT" -eq 0 ]; then
              echo "WARNING: No changes to commit. Files might be identical to existing ones."
              echo "Current wheelhouse contents:"
              ls -lah wheelhouse/
              # Don't fail here - just skip the commit if nothing changed
              echo "Skipping commit as files are unchanged."
            else
              echo "Files staged after force add: $STAGED_COUNT"
            fi
          fi
          
          if [ "$STAGED_COUNT" -gt 0 ]; then
            echo "Committing $STAGED_COUNT files..."
            git commit -m "${COMMIT_MSG}"
            
            # Show what was committed
            echo "Committed changes:"
            git show --stat
            
            echo "Force pushing to build branch..."
            git push --force origin build
            echo "Successfully pushed wheelhouse files!"
          else
            echo "No changes to push."
          fi

      - name: Create or update Pull Request (build ‚Üí develop)
        id: create_or_update_pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ARTIFACTS_URL: ${{ env.RUN_URL }}
        run: |
          set -euo pipefail
          OWNER_REPO="${GITHUB_REPOSITORY}"
          OWNER="$(echo "$OWNER_REPO" | cut -d'/' -f1)"
          REPO="$(echo "$OWNER_REPO" | cut -d'/' -f2)"
          HEAD_BRANCH="build"
          BASE_BRANCH="develop"
          TITLE="üé° Update Wheelhouse - Build #${RUN_ID}"
          BODY="This PR updates the wheelhouse with artifacts from build run ${RUN_ID}.

          The wheelhouse files are now in the 'build' branch.
          
          Action run: ${ARTIFACTS_URL}"

          echo "Checking for an existing open PR from ${HEAD_BRANCH} to ${BASE_BRANCH}..."
          existing_pr=$(curl -s -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${OWNER}/${REPO}/pulls?head=${OWNER}:${HEAD_BRANCH}&base=${BASE_BRANCH}&state=open" | jq -r '.[0].number // empty')

          if [ -n "$existing_pr" ]; then
            echo "Found existing PR #$existing_pr ‚Äî updating title/body"
            curl -s -X PATCH -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" \
              -d "$(jq -n --arg t "$TITLE" --arg b "$BODY" '{title:$t, body:$b}')" \
              "https://api.github.com/repos/${OWNER}/${REPO}/pulls/${existing_pr}"
            echo "PR_UPDATED=${existing_pr}" >> $GITHUB_ENV
          else
            echo "No existing PR ‚Äî creating a new PR from ${HEAD_BRANCH} to ${BASE_BRANCH}"
            pr_resp=$(curl -s -X POST -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" \
              -d "$(jq -n --arg head "$HEAD_BRANCH" --arg base "$BASE_BRANCH" --arg title "$TITLE" --arg body "$BODY" '{head:$head, base:$base, title:$title, body:$body}')" \
              "https://api.github.com/repos/${OWNER}/${REPO}/pulls")
            pr_number=$(echo "$pr_resp" | jq -r '.number // empty')
            if [ -z "$pr_number" ]; then
              echo "ERROR: failed to create PR" >&2
              echo "Response: $pr_resp"
              exit 1
            fi
            echo "PR_CREATED=${pr_number}" >> $GITHUB_ENV
          fi

      - name: Add PR comment with instructions
        if: ${{ env.PR_CREATED || env.PR_UPDATED }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ARTIFACTS_URL: ${{ env.RUN_URL }}
        run: |
          set -euo pipefail
          # Use the PR number from previous step
          PR_NUM="${PR_CREATED:-${PR_UPDATED:-}}"
          
          if [ -z "$PR_NUM" ]; then
            echo "No PR number available to comment on."
            exit 0
          fi

          COMMENT_BODY="## üì¶ Wheelhouse

          This PR includes the wheelhouse files built by Maturin.
          Wheels include Python versions '>=3.10,<3.14' for Linux, macOS, and Windows.

          <details>
          <summary>View wheelhouse contents</summary>

          \`\`\`plaintext
          $(ls -1 wheelhouse/ | head -n 50 | tr '\n' '\n')
          \`\`\`

          </details>

          The full wheelhouse is available in the 'wheelhouse' directory.

          <details>
          <summary>Release archives</summary>

          The following release archives are available for each version:

          - \`*.whl\`: Built wheels
          - \`*.tar.gz\`: Source archives
          - \`CHECKSUMS.sha256\`: Checksums for all files

          </details>

          <br>

          ‚ö†Ô∏è **Note**: If this PR is not merged within 30 days, the artifacts will be deleted.

          <!--
          The artifacts from the CI run are available here: $ARTIFACTS_URL
          -->"

          echo "Posting comment on PR #$PR_NUM..."
          curl -s -X POST -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" -H "Accept: application/vnd.github+json" \
            -d "{\"body\":\"$COMMENT_BODY\"}" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/issues/${PR_NUM}/comments"
