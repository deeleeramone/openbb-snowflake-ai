name: Build wheels

on:
  workflow_dispatch:

jobs:
  build:
    name: build on ${{ matrix.os }} (${{ matrix.target }} - ${{ matrix.interpreter || 'all' }}${{ matrix.os == 'linux' && format(' - {0}', matrix.manylinux == 'auto' && 'manylinux' || matrix.manylinux) || '' }})
    strategy:
      fail-fast: false
      matrix:
        os: [linux, macos, windows]
        target: [undefined]
        manylinux: [auto]
        include:
          # manylinux for various platforms
          # x86_64 and aarch64 are PGO optimized below
          - os: linux
            manylinux: auto
            target: i686
          - os: linux
            manylinux: auto
            target: armv7
            interpreter: 3.10 3.11 3.12 3.13 
          - os: linux
            manylinux: auto
            target: ppc64le
            interpreter: 3.10 3.11 3.12 3.13 
          - os: linux
            manylinux: auto
            target: s390x
            interpreter: 3.10 3.11 3.12 3.13 
          - os: linux
            manylinux: auto
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13
          - os: linux
            manylinux: auto
            target: aarch64
            interpreter: 3.10 3.11 3.12 3.13

          # musllinux
          - os: linux
            manylinux: musllinux_1_1
            target: x86_64
          - os: linux
            manylinux: musllinux_1_1
            target: aarch64
          - os: linux
            manylinux: musllinux_1_1
            target: armv7

          - os: macos
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13
          - os: macos
            target: aarch64
            interpreter: 3.10 3.11 3.12 3.13

          - os: windows
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13 
          - os: windows
            target: aarch64
            runs-on: windows-11-arm
            interpreter: 3.11 3.12 3.13

        exclude:
          # was just a dummy variable to set a default value for target
          - target: undefined

    runs-on: ${{ matrix.runs-on || format('{0}-latest', (matrix.os == 'linux' && 'ubuntu') || matrix.os) }}
    steps:
      - uses: actions/checkout@v4

      - name: set up python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          architecture: ${{ matrix.python-architecture || 'x64' }}

      - name: Install OpenSSL development headers (Ubuntu)
        if: matrix.os == 'linux'
        run: |
          if command -v apt-get > /dev/null; then
            sudo apt-get update
            sudo apt-get install -y libssl-dev
          elif command -v yum > /dev/null; then
            yum install -y openssl-devel openssl-static
          fi

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos'
        run: |
          brew install openssl@3 sqlcipher pkg-config
          echo "OPENSSL_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$(brew --prefix openssl@3)/lib/pkgconfig:$(brew --prefix sqlcipher)/lib/pkgconfig" >> $GITHUB_ENV
          # Explicitly tell Rust linker where to find sqlcipher
          echo "RUSTFLAGS=-L $(brew --prefix sqlcipher)/lib" >> $GITHUB_ENV

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows'
        run: |
          vcpkg install openssl:x64-windows sqlcipher:x64-windows
          echo "OPENSSL_DIR=C:/vcpkg/installed/x64-windows" >> $GITHUB_ENV
          echo "SQLCIPHER_LIB_DIR=C:/vcpkg/installed/x64-windows/lib" >> $GITHUB_ENV
          echo "SQLCIPHER_INCLUDE_DIR=C:/vcpkg/installed/x64-windows/include" >> $GITHUB_ENV

      - run: pip install -U ruff typing_extensions

      - name: build wheels
        uses: PyO3/maturin-action@v1
        env:
          # Workaround for ring crate build failure on aarch64
          CFLAGS_aarch64_unknown_linux_gnu: "-D__ARM_ARCH=8"
          CFLAGS_aarch64_unknown_linux_musl: "-D__ARM_ARCH=8"
          # Workaround for ring crate build failure on armv7
          CFLAGS_armv7_unknown_linux_gnueabihf: "-D__ARM_ARCH=7"
          CFLAGS_armv7_unknown_linux_musleabihf: "-D__ARM_ARCH=7"
        with:
          target: ${{ matrix.target }}
          manylinux: ${{ matrix.manylinux }}
          args: --release --out dist --interpreter ${{ matrix.interpreter || '3.10 3.11 3.12 3.13' }}
          rust-toolchain: stable
          docker-options: >-
            -e CI 
            -e TARGET=${{ matrix.target }}
            -e CFLAGS_aarch64_unknown_linux_gnu
            -e CFLAGS_aarch64_unknown_linux_musl
            -e CFLAGS_armv7_unknown_linux_gnueabihf
            -e CFLAGS_armv7_unknown_linux_musleabihf
          before-script-linux: |
            set -e
            set -x
            
            # Detect the libc type and set up OpenSSL accordingly
            if command -v apk > /dev/null; then
              # =================== ALPINE/MUSL LINUX ===================
              echo "Detected Alpine/musl environment"
              
              # Add edge repositories for latest packages
              echo "http://dl-cdn.alpinelinux.org/alpine/edge/community" >> /etc/apk/repositories
              echo "http://dl-cdn.alpinelinux.org/alpine/edge/main" >> /etc/apk/repositories
              apk update
              
              # Install ALL necessary build dependencies
              apk add --no-cache \
                pkgconfig \
                perl \
                make \
                gcc \
                musl-dev \
                git \
                tcl \
                openssl-dev \
                openssl-libs-static \
                sqlcipher-dev \
                linux-headers
              
              # Set OpenSSL paths for musl
              export OPENSSL_DIR=/usr
              export OPENSSL_STATIC=1
              export OPENSSL_LIB_DIR=/usr/lib
              export OPENSSL_INCLUDE_DIR=/usr/include
              
              # Set target-specific environment variables for cross-compilation
              case "${TARGET}" in
                aarch64-unknown-linux-musl)
                  export AARCH64_UNKNOWN_LINUX_MUSL_OPENSSL_DIR=/usr
                  export AARCH64_UNKNOWN_LINUX_MUSL_OPENSSL_STATIC=1
                  ;;
                armv7-unknown-linux-musleabihf)
                  export ARMV7_UNKNOWN_LINUX_MUSLEABIHF_OPENSSL_DIR=/usr
                  export ARMV7_UNKNOWN_LINUX_MUSLEABIHF_OPENSSL_STATIC=1
                  ;;
                x86_64-unknown-linux-musl)
                  export X86_64_UNKNOWN_LINUX_MUSL_OPENSSL_DIR=/usr
                  export X86_64_UNKNOWN_LINUX_MUSL_OPENSSL_STATIC=1
                  ;;
              esac
              
              # Set PKG_CONFIG for musl
              export PKG_CONFIG_PATH=/usr/lib/pkgconfig:${PKG_CONFIG_PATH:-}
              export PKG_CONFIG_ALLOW_CROSS=1
              
            elif command -v yum > /dev/null; then
              # =================== CENTOS/RHEL (MANYLINUX) ===================
              echo "Detected CentOS/RHEL environment"
              
              # Install EPEL for additional packages
              yum install -y epel-release || true
              
              # Install base build tools
              yum install -y \
                pkgconfig \
                perl-core \
                make \
                gcc \
                gcc-c++ \
                git \
                tcl \
                curl \
                autoconf \
                automake \
                libtool \
                openssl-devel \
                openssl-static || true
              
              # Handle cross-compilation targets
              case "${TARGET}" in
                aarch64|aarch64-unknown-linux-gnu)
                  # Try to install cross-compilation tools
                  yum install -y gcc-aarch64-linux-gnu || true
                  export AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_DIR=/usr
                  export OPENSSL_DIR=/usr
                  export OPENSSL_STATIC=1
                  export OPENSSL_LIB_DIR=/usr/lib64
                  export OPENSSL_INCLUDE_DIR=/usr/include
                  ;;
                armv7|armv7-unknown-linux-gnueabihf)
                  yum install -y gcc-arm-linux-gnu || true
                  export ARMV7_UNKNOWN_LINUX_GNUEABIHF_OPENSSL_DIR=/usr
                  export OPENSSL_DIR=/usr
                  export OPENSSL_STATIC=1
                  export OPENSSL_LIB_DIR=/usr/lib64
                  export OPENSSL_INCLUDE_DIR=/usr/include
                  ;;
                ppc64le|powerpc64le-unknown-linux-gnu)
                  export POWERPC64LE_UNKNOWN_LINUX_GNU_OPENSSL_DIR=/usr
                  export OPENSSL_DIR=/usr
                  export OPENSSL_STATIC=1
                  export OPENSSL_LIB_DIR=/usr/lib64
                  export OPENSSL_INCLUDE_DIR=/usr/include
                  ;;
                s390x|s390x-unknown-linux-gnu)
                  export S390X_UNKNOWN_LINUX_GNU_OPENSSL_DIR=/usr
                  export OPENSSL_DIR=/usr
                  export OPENSSL_STATIC=1
                  export OPENSSL_LIB_DIR=/usr/lib64
                  export OPENSSL_INCLUDE_DIR=/usr/include
                  ;;
                *)
                  # Default x86_64 or i686
                  export OPENSSL_DIR=/usr
                  export OPENSSL_STATIC=1
                  if [ -d /usr/lib64 ]; then
                    export OPENSSL_LIB_DIR=/usr/lib64
                  else
                    export OPENSSL_LIB_DIR=/usr/lib
                  fi
                  export OPENSSL_INCLUDE_DIR=/usr/include
                  ;;
              esac
              
              # Build SQLCipher from source as it's not in standard repos
              SQLCIPHER_VERSION=4.5.6
              SQLCIPHER_PREFIX=/opt/sqlcipher
              SQLCIPHER_BUILD_DIR=$(mktemp -d)
              
              curl -fsSL "https://github.com/sqlcipher/sqlcipher/archive/refs/tags/v${SQLCIPHER_VERSION}.tar.gz" | tar -xz -C "${SQLCIPHER_BUILD_DIR}"
              cd "${SQLCIPHER_BUILD_DIR}/sqlcipher-${SQLCIPHER_VERSION}"
              
              CFLAGS="-I${OPENSSL_INCLUDE_DIR}" LDFLAGS="-L${OPENSSL_LIB_DIR}" \
              ./configure \
                --prefix="${SQLCIPHER_PREFIX}" \
                --enable-tempstore=yes \
                --disable-tcl \
                --with-crypto-lib=openssl \
                --enable-static=yes \
                --enable-shared=no
              
              make -j"$(nproc)"
              make install
              cd /
              rm -rf "${SQLCIPHER_BUILD_DIR}"
              
              export SQLCIPHER_LIB_DIR="${SQLCIPHER_PREFIX}/lib"
              export SQLCIPHER_INCLUDE_DIR="${SQLCIPHER_PREFIX}/include"
              export PKG_CONFIG_PATH="${SQLCIPHER_PREFIX}/lib/pkgconfig:${PKG_CONFIG_PATH:-}"
              
            elif command -v apt-get > /dev/null; then
              # =================== DEBIAN/UBUNTU ===================
              echo "Detected Debian/Ubuntu environment"
              
              # Set up timezone to avoid interactive prompts
              export DEBIAN_FRONTEND=noninteractive
              export TZ=Etc/UTC
              sudo ln -fs "/usr/share/zoneinfo/${TZ}" /etc/localtime
              echo "${TZ}" | sudo tee /etc/timezone >/dev/null
              
              # Determine cross-compilation settings
              case "${TARGET}" in
                aarch64|aarch64-unknown-linux-gnu)
                  CROSS_ARCH=arm64
                  CROSS_LIB_DIR=/usr/lib/aarch64-linux-gnu
                  CROSS_INCLUDE_DIR=/usr/include/aarch64-linux-gnu
                  TARGET_TRIPLE=aarch64-linux-gnu
                  ;;
                armv7|armv7-unknown-linux-gnueabihf)
                  CROSS_ARCH=armhf
                  CROSS_LIB_DIR=/usr/lib/arm-linux-gnueabihf
                  CROSS_INCLUDE_DIR=/usr/include/arm-linux-gnueabihf
                  TARGET_TRIPLE=arm-linux-gnueabihf
                  ;;
                ppc64le|powerpc64le-unknown-linux-gnu)
                  CROSS_ARCH=ppc64el
                  CROSS_LIB_DIR=/usr/lib/powerpc64le-linux-gnu
                  CROSS_INCLUDE_DIR=/usr/include/powerpc64le-linux-gnu
                  TARGET_TRIPLE=powerpc64le-linux-gnu
                  ;;
                s390x|s390x-unknown-linux-gnu)
                  CROSS_ARCH=s390x
                  CROSS_LIB_DIR=/usr/lib/s390x-linux-gnu
                  CROSS_INCLUDE_DIR=/usr/include/s390x-linux-gnu
                  TARGET_TRIPLE=s390x-linux-gnu
                  ;;
                i686|i686-unknown-linux-gnu)
                  CROSS_ARCH=i386
                  CROSS_LIB_DIR=/usr/lib/i386-linux-gnu
                  CROSS_INCLUDE_DIR=/usr/include/i386-linux-gnu
                  TARGET_TRIPLE=i386-linux-gnu
                  ;;
                *)
                  # x86_64 or default
                  CROSS_ARCH=""
                  CROSS_LIB_DIR=/usr/lib/x86_64-linux-gnu
                  CROSS_INCLUDE_DIR=/usr/include/x86_64-linux-gnu
                  TARGET_TRIPLE=x86_64-linux-gnu
                  ;;
              esac
              
              # Add architecture and configure apt for cross-compilation if needed
              if [ -n "${CROSS_ARCH}" ] && [ "${CROSS_ARCH}" != "$(dpkg --print-architecture)" ]; then
                sudo dpkg --add-architecture "${CROSS_ARCH}"
                
                # Fix apt sources for cross-compilation
                if [ -f /etc/os-release ]; then
                  . /etc/os-release
                  HOST_ARCH=$(dpkg --print-architecture)
                  
                  # Backup original sources
                  sudo cp /etc/apt/sources.list /etc/apt/sources.list.backup
                  
                  # Add architecture restrictions to prevent 404s
                  sudo sed -i "s/^deb \([^\[]\)/deb [arch=${HOST_ARCH}] \1/g" /etc/apt/sources.list
                  
                  # Add ports repository for cross architectures
                  if [ "${ID}" = "ubuntu" ]; then
                    CODENAME=${VERSION_CODENAME:-jammy}
                    echo "deb [arch=${CROSS_ARCH}] http://ports.ubuntu.com/ubuntu-ports ${CODENAME} main restricted universe multiverse" | sudo tee /etc/apt/sources.list.d/ports.list
                    echo "deb [arch=${CROSS_ARCH}] http://ports.ubuntu.com/ubuntu-ports ${CODENAME}-updates main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list.d/ports.list
                    echo "deb [arch=${CROSS_ARCH}] http://ports.ubuntu.com/ubuntu-ports ${CODENAME}-security main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list.d/ports.list
                  fi
                fi
              fi
              
              # Update package lists
              sudo apt-get update
              
              # Install base build dependencies
              sudo apt-get install -y \
                tzdata \
                pkg-config \
                build-essential \
                dpkg-dev \
                git \
                tcl \
                curl \
                libssl-dev \
                libsqlcipher-dev
              
              # Install cross-compilation dependencies if needed
              if [ -n "${CROSS_ARCH}" ] && [ "${CROSS_ARCH}" != "$(dpkg --print-architecture)" ]; then
                sudo apt-get install -y \
                  "libssl-dev:${CROSS_ARCH}" \
                  "libsqlcipher-dev:${CROSS_ARCH}" \
                  crossbuild-essential-"${CROSS_ARCH}" || true
              fi
              
              # Set OpenSSL environment variables
              export OPENSSL_DIR=/usr
              export OPENSSL_STATIC=1
              export OPENSSL_LIB_DIR="${CROSS_LIB_DIR}"
              export OPENSSL_INCLUDE_DIR="${CROSS_INCLUDE_DIR}"
              export SQLCIPHER_LIB_DIR="${CROSS_LIB_DIR}"
              export SQLCIPHER_INCLUDE_DIR="${CROSS_INCLUDE_DIR}"
              
              # Set target-specific variables
              case "${TARGET}" in
                aarch64|aarch64-unknown-linux-gnu)
                  export AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_DIR=/usr
                  export AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_LIB_DIR="${CROSS_LIB_DIR}"
                  export AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_INCLUDE_DIR="${CROSS_INCLUDE_DIR}"
                  ;;
                armv7|armv7-unknown-linux-gnueabihf)
                  export ARMV7_UNKNOWN_LINUX_GNUEABIHF_OPENSSL_DIR=/usr
                  export ARMV7_UNKNOWN_LINUX_GNUEABIHF_OPENSSL_LIB_DIR="${CROSS_LIB_DIR}"
                  export ARMV7_UNKNOWN_LINUX_GNUEABIHF_OPENSSL_INCLUDE_DIR="${CROSS_INCLUDE_DIR}"
                  ;;
                ppc64le|powerpc64le-unknown-linux-gnu)
                  export POWERPC64LE_UNKNOWN_LINUX_GNU_OPENSSL_DIR=/usr
                  export POWERPC64LE_UNKNOWN_LINUX_GNU_OPENSSL_LIB_DIR="${CROSS_LIB_DIR}"
                  export POWERPC64LE_UNKNOWN_LINUX_GNU_OPENSSL_INCLUDE_DIR="${CROSS_INCLUDE_DIR}"
                  ;;
                s390x|s390x-unknown-linux-gnu)
                  export S390X_UNKNOWN_LINUX_GNU_OPENSSL_DIR=/usr
                  export S390X_UNKNOWN_LINUX_GNU_OPENSSL_LIB_DIR="${CROSS_LIB_DIR}"
                  export S390X_UNKNOWN_LINUX_GNU_OPENSSL_INCLUDE_DIR="${CROSS_INCLUDE_DIR}"
                  ;;
                i686|i686-unknown-linux-gnu)
                  export I686_UNKNOWN_LINUX_GNU_OPENSSL_DIR=/usr
                  export I686_UNKNOWN_LINUX_GNU_OPENSSL_LIB_DIR="${CROSS_LIB_DIR}"
                  export I686_UNKNOWN_LINUX_GNU_OPENSSL_INCLUDE_DIR="${CROSS_INCLUDE_DIR}"
                  ;;
              esac
              
              # Set PKG_CONFIG_PATH
              export PKG_CONFIG_PATH="${CROSS_LIB_DIR}/pkgconfig:${PKG_CONFIG_PATH:-}"
              export PKG_CONFIG_ALLOW_CROSS=1
            fi
            
            # Common environment setup for all Linux variants
            export LD_LIBRARY_PATH="${OPENSSL_LIB_DIR}:${SQLCIPHER_LIB_DIR}:${LD_LIBRARY_PATH:-}"
            export LIBRARY_PATH="${OPENSSL_LIB_DIR}:${SQLCIPHER_LIB_DIR}:${LIBRARY_PATH:-}"
            export RUSTFLAGS="${RUSTFLAGS:-} -L${OPENSSL_LIB_DIR} -L${SQLCIPHER_LIB_DIR:-/usr/lib}"
            
            # Debug output to verify configuration
            echo "=================== BUILD CONFIGURATION ==================="
            echo "TARGET: ${TARGET}"
            echo "OPENSSL_DIR: ${OPENSSL_DIR}"
            echo "OPENSSL_LIB_DIR: ${OPENSSL_LIB_DIR}"
            echo "OPENSSL_INCLUDE_DIR: ${OPENSSL_INCLUDE_DIR}"
            echo "SQLCIPHER_LIB_DIR: ${SQLCIPHER_LIB_DIR}"
            echo "PKG_CONFIG_PATH: ${PKG_CONFIG_PATH}"
            echo "RUSTFLAGS: ${RUSTFLAGS}"
            echo "==========================================================="
            
            # Verify OpenSSL installation
            if [ -n "${OPENSSL_INCLUDE_DIR}" ] && [ -d "${OPENSSL_INCLUDE_DIR}" ]; then
              echo "OpenSSL headers found:"
              ls -la "${OPENSSL_INCLUDE_DIR}/openssl/" 2>/dev/null | head -5 || echo "No OpenSSL headers in ${OPENSSL_INCLUDE_DIR}"
            fi
            
            if [ -n "${OPENSSL_LIB_DIR}" ] && [ -d "${OPENSSL_LIB_DIR}" ]; then
              echo "OpenSSL libraries found:"
              ls -la "${OPENSSL_LIB_DIR}"/*ssl* 2>/dev/null | head -5 || echo "No OpenSSL libraries in ${OPENSSL_LIB_DIR}"
            fi
            
            # Final check
            echo "Build environment configured successfully!"

      - run: ${{ (matrix.os == 'windows' && 'dir') || 'ls -lh' }} dist/

      - uses: actions/upload-artifact@v4
        with:
          name: pypi_files_${{ matrix.os }}_${{ matrix.target }}_${{ matrix.interpreter || 'all' }}_${{ matrix.manylinux }}
          path: dist
