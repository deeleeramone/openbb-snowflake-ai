name: Build wheels

on:
  workflow_dispatch:

jobs:
  build:
    name: build on ${{ matrix.os }} (${{ matrix.target }} - ${{ matrix.interpreter || 'all' }}${{ matrix.os == 'linux' && format(' - {0}', matrix.manylinux == 'auto' && 'manylinux' || matrix.manylinux) || '' }})
    strategy:
      fail-fast: false
      matrix:
        os: [linux, macos, windows]
        target: [undefined]
        manylinux: [auto]
        include:
          # manylinux for various platforms
          # x86_64 and aarch64 are PGO optimized below
          - os: linux
            manylinux: auto
            target: i686
          - os: linux
            manylinux: auto
            target: armv7
            interpreter: 3.10 3.11 3.12 3.13 
          - os: linux
            manylinux: auto
            target: ppc64le
            interpreter: 3.10 3.11 3.12 3.13 
          - os: linux
            manylinux: auto
            target: s390x
            interpreter: 3.10 3.11 3.12 3.13 
          - os: linux
            manylinux: auto
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13
          - os: linux
            manylinux: auto
            target: aarch64
            interpreter: 3.10 3.11 3.12 3.13

          # musllinux
          - os: linux
            manylinux: musllinux_1_1
            target: x86_64
          - os: linux
            manylinux: musllinux_1_1
            target: aarch64
          - os: linux
            manylinux: musllinux_1_1
            target: armv7

          - os: macos
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13
          - os: macos
            target: aarch64
            interpreter: 3.10 3.11 3.12 3.13

          - os: windows
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13 
          - os: windows
            target: aarch64
            runs-on: windows-11-arm
            interpreter: 3.11 3.12 3.13

        exclude:
          # was just a dummy variable to set a default value for target
          - target: undefined

    runs-on: ${{ matrix.runs-on || format('{0}-latest', (matrix.os == 'linux' && 'ubuntu') || matrix.os) }}
    steps:
      - uses: actions/checkout@v4

      - name: set up python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          architecture: ${{ matrix.python-architecture || 'x64' }}

      - name: Install OpenSSL development headers (Ubuntu)
        if: matrix.os == 'linux'
        run: |
          if command -v apt-get > /dev/null; then
            sudo apt-get update
            sudo apt-get install -y libssl-dev
          elif command -v yum > /dev/null; then
            yum install -y openssl-devel openssl-static
          fi

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos'
        run: |
          brew install openssl@3 sqlcipher pkg-config
          echo "OPENSSL_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$(brew --prefix openssl@3)/lib/pkgconfig:$(brew --prefix sqlcipher)/lib/pkgconfig" >> $GITHUB_ENV
          # Explicitly tell Rust linker where to find sqlcipher
          echo "RUSTFLAGS=-L $(brew --prefix sqlcipher)/lib" >> $GITHUB_ENV

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows'
        run: |
          vcpkg install openssl:x64-windows sqlcipher:x64-windows
          echo "OPENSSL_DIR=C:/vcpkg/installed/x64-windows" >> $GITHUB_ENV
          echo "SQLCIPHER_LIB_DIR=C:/vcpkg/installed/x64-windows/lib" >> $GITHUB_ENV
          echo "SQLCIPHER_INCLUDE_DIR=C:/vcpkg/installed/x64-windows/include" >> $GITHUB_ENV

      - run: pip install -U ruff typing_extensions

      - name: build wheels
        uses: PyO3/maturin-action@v1
        env:
          # Workaround for ring crate build failure on aarch64
          CFLAGS_aarch64_unknown_linux_gnu: "-D__ARM_ARCH=8"
          CFLAGS_aarch64_unknown_linux_musl: "-D__ARM_ARCH=8"
          # Workaround for ring crate build failure on armv7
          CFLAGS_armv7_unknown_linux_gnueabihf: "-D__ARM_ARCH=7"
          CFLAGS_armv7_unknown_linux_musleabihf: "-D__ARM_ARCH=7"
        with:
          target: ${{ matrix.target }}
          manylinux: ${{ matrix.manylinux }}
          args: --release --out dist --interpreter ${{ matrix.interpreter || '3.10 3.11 3.12 3.13' }}
          rust-toolchain: stable
          docker-options: >-
            -e CI 
            -e TARGET=${{ matrix.target }}
            -e CFLAGS_aarch64_unknown_linux_gnu
            -e CFLAGS_aarch64_unknown_linux_musl
            -e CFLAGS_armv7_unknown_linux_gnueabihf
            -e CFLAGS_armv7_unknown_linux_musleabihf
          before-script-linux: |
            set -e
            set -x
            
            # Install build dependencies
            if command -v apk > /dev/null; then
              # Alpine (musl)
              echo "http://dl-cdn.alpinelinux.org/alpine/edge/community" >> /etc/apk/repositories
              echo "http://dl-cdn.alpinelinux.org/alpine/edge/main" >> /etc/apk/repositories
              apk update
              apk add pkgconfig perl make gcc musl-dev git tcl sqlcipher-dev openssl-dev openssl-libs-static
              
              # For musl cross-compilation, set the correct paths
              export OPENSSL_DIR=/usr
              export OPENSSL_STATIC=1
              export OPENSSL_LIB_DIR=/usr/lib
              export OPENSSL_INCLUDE_DIR=/usr/include
            elif command -v yum > /dev/null; then
              # CentOS/RHEL (manylinux2014)
              yum install -y epel-release || true
              yum install -y pkgconfig perl-core make gcc git tcl curl autoconf automake libtool || true
              
              # For cross-compilation targets, install the appropriate OpenSSL
              if [ "${TARGET}" = "aarch64" ] || [ "${TARGET}" = "aarch64-unknown-linux-gnu" ]; then
                # Install aarch64 OpenSSL development files
                yum install -y openssl-devel.aarch64
                # Set OpenSSL to the cross-compilation directory
                export AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_DIR=/usr/aarch64-unknown-linux-gnu
                export OPENSSL_DIR=/usr/aarch64-unknown-linux-gnu
                export OPENSSL_STATIC=1
                
                # Create symlink for opensslconf.h if needed
                if [ -f /usr/include/openssl/opensslconf-aarch64.h ]; then
                  mkdir -p /usr/aarch64-unknown-linux-gnu/include/openssl
                  ln -sf /usr/include/openssl/*.h /usr/aarch64-unknown-linux-gnu/include/openssl/ 2>/dev/null || true
                  ln -sf /usr/include/openssl/opensslconf-aarch64.h /usr/aarch64-unknown-linux-gnu/include/openssl/opensslconf.h
                fi
              elif [ "${TARGET}" = "armv7" ] || [ "${TARGET}" = "armv7-unknown-linux-gnueabihf" ]; then
                export ARMV7_UNKNOWN_LINUX_GNUEABIHF_OPENSSL_DIR=/usr/armv7-unknown-linux-gnueabihf
                export OPENSSL_DIR=/usr/armv7-unknown-linux-gnueabihf
                export OPENSSL_STATIC=1
              elif [ "${TARGET}" = "x86_64" ] || [ "${TARGET}" = "x86_64-unknown-linux-gnu" ]; then
                # For native x86_64, just install normally
                yum install -y openssl-devel openssl-static || true
                export OPENSSL_DIR=/usr
                export OPENSSL_STATIC=1
                export OPENSSL_LIB_DIR=/usr/lib64
                export OPENSSL_INCLUDE_DIR=/usr/include
              else
                # Default: install host OpenSSL
                yum install -y openssl-devel openssl-static || true
                export OPENSSL_DIR=/usr
                export OPENSSL_STATIC=1
              fi
              
              # Try to install sqlcipher-devel but don't fail if it's not available
              yum install -y sqlcipher-devel || echo "sqlcipher-devel not found in yum"
              if pkg-config --exists sqlcipher; then
                export SQLCIPHER_LIB_DIR=/usr/lib64
                export SQLCIPHER_INCLUDE_DIR=/usr/include
              else
                SQLCIPHER_VERSION=4.5.6
                SQLCIPHER_PREFIX=/opt/sqlcipher-${TARGET:-host}
                SQLCIPHER_BUILD_DIR=$(mktemp -d)
                curl -fsSL "https://github.com/sqlcipher/sqlcipher/archive/refs/tags/v${SQLCIPHER_VERSION}.tar.gz" | tar -xz -C "${SQLCIPHER_BUILD_DIR}"
                ORIG_DIR=$(pwd)
                cd "${SQLCIPHER_BUILD_DIR}/sqlcipher-${SQLCIPHER_VERSION}"
                ./configure --prefix="${SQLCIPHER_PREFIX}" --enable-tempstore=yes --disable-tcl --with-crypto-lib=openssl
                make -j"$(nproc)"
                make install
                cd "${ORIG_DIR}"
                rm -rf "${SQLCIPHER_BUILD_DIR}"
                export PKG_CONFIG_PATH="${SQLCIPHER_PREFIX}/lib/pkgconfig:${PKG_CONFIG_PATH}"
                export SQLCIPHER_LIB_DIR="${SQLCIPHER_PREFIX}/lib"
                export SQLCIPHER_INCLUDE_DIR="${SQLCIPHER_PREFIX}/include"
              fi
              export PKG_CONFIG_PATH="${SQLCIPHER_LIB_DIR}/pkgconfig:${PKG_CONFIG_PATH:-}"
              export LD_LIBRARY_PATH="${SQLCIPHER_LIB_DIR}:${LD_LIBRARY_PATH}"
              export LIBRARY_PATH="${SQLCIPHER_LIB_DIR}:${LIBRARY_PATH}"
              export RUSTFLAGS="${RUSTFLAGS} -L${SQLCIPHER_LIB_DIR}"
            elif command -v apt-get > /dev/null; then
              export DEBIAN_FRONTEND=noninteractive
              export TZ=Etc/UTC
              sudo ln -fs "/usr/share/zoneinfo/${TZ}" /etc/localtime
              echo "${TZ}" | sudo tee /etc/timezone >/dev/null
              sudo apt-get update
              sudo apt-get install -y tzdata pkg-config build-essential dpkg-dev git tcl curl libsqlcipher-dev libssl-dev
              if [ -n "${CROSS_ARCH}" ]; then
                sudo apt-get install -y "libssl-dev:${CROSS_ARCH}" "libsqlcipher-dev:${CROSS_ARCH}"
                export OPENSSL_LIB_DIR="${CROSS_LIB_DIR}"
                export OPENSSL_INCLUDE_DIR="${CROSS_INCLUDE_DIR}"
                export SQLCIPHER_LIB_DIR="${CROSS_LIB_DIR}"
                export SQLCIPHER_INCLUDE_DIR="${CROSS_INCLUDE_DIR}"
                case "${TARGET}" in
                  aarch64|aarch64-unknown-linux-gnu)
                    export AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_DIR=/usr
                    export AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_LIB_DIR="${CROSS_LIB_DIR}"
                    export AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_INCLUDE_DIR="${CROSS_INCLUDE_DIR}"
                    ;;
                  armv7|armv7-unknown-linux-gnueabihf)
                    export ARMV7_UNKNOWN_LINUX_GNUEABIHF_OPENSSL_DIR=/usr
                    export ARMV7_UNKNOWN_LINUX_GNUEABIHF_OPENSSL_LIB_DIR="${CROSS_LIB_DIR}"
                    export ARMV7_UNKNOWN_LINUX_GNUEABIHF_OPENSSL_INCLUDE_DIR="${CROSS_INCLUDE_DIR}"
                    ;;
                esac
              else
                HOST_MULTIARCH="$(dpkg-architecture -qDEB_HOST_MULTIARCH 2>/dev/null || echo x86_64-linux-gnu)"
                export OPENSSL_LIB_DIR="/usr/lib/${HOST_MULTIARCH}"
                export OPENSSL_INCLUDE_DIR="/usr/include/${HOST_MULTIARCH}"
                export SQLCIPHER_LIB_DIR="/usr/lib/${HOST_MULTIARCH}"
                export SQLCIPHER_INCLUDE_DIR="/usr/include/${HOST_MULTIARCH}"
              fi
              if [ -d "${SQLCIPHER_LIB_DIR}/pkgconfig" ]; then
                export PKG_CONFIG_PATH="${SQLCIPHER_LIB_DIR}/pkgconfig:${PKG_CONFIG_PATH:-}"
              fi
              export LD_LIBRARY_PATH="${SQLCIPHER_LIB_DIR}:${LD_LIBRARY_PATH}"
              export LIBRARY_PATH="${SQLCIPHER_LIB_DIR}:${LIBRARY_PATH}"
              export RUSTFLAGS="${RUSTFLAGS} -L${SQLCIPHER_LIB_DIR}"
              export OPENSSL_DIR=/usr
              export OPENSSL_STATIC=1
            fi
            
            # Debug: Show what we found
            echo "TARGET=${TARGET}"
            echo "OPENSSL_DIR=${OPENSSL_DIR}"
            if [ -n "${OPENSSL_DIR}" ]; then
              echo "OpenSSL headers in ${OPENSSL_DIR}:"
              ls -la ${OPENSSL_DIR}/include/openssl/ 2>/dev/null || echo "Headers not found"
              echo "OpenSSL libraries in ${OPENSSL_DIR}:"
              ls -la ${OPENSSL_DIR}/lib*/*ssl* 2>/dev/null || echo "Libraries not found"
            fi

      - run: ${{ (matrix.os == 'windows' && 'dir') || 'ls -lh' }} dist/

      - uses: actions/upload-artifact@v4
        with:
          name: pypi_files_${{ matrix.os }}_${{ matrix.target }}_${{ matrix.interpreter || 'all' }}_${{ matrix.manylinux }}
          path: dist
