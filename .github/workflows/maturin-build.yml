name: Build wheels

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: write

jobs:
  build:
    name: build on ${{ matrix.os }} (${{ matrix.target }} - ${{ matrix.interpreter || 'all' }})
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux builds - modern architectures only
          - os: linux
            target: amd64
            interpreter: 3.10 3.11 3.12 3.13
          - os: linux
            target: aarch64
            interpreter: 3.10 3.11 3.12 3.13

          # macOS builds
          - os: macos
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13
          - os: macos
            target: aarch64
            interpreter: 3.10 3.11 3.12 3.13

          # Windows builds
          - os: windows
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13 
          - os: windows
            target: aarch64
            runs-on: windows-11-arm
            interpreter: 3.11 3.12 3.13

    runs-on: ${{ matrix.runs-on || format('{0}-latest', (matrix.os == 'linux' && 'ubuntu') || matrix.os) }}
    steps:
      - uses: actions/checkout@v4

      - name: set up python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          architecture: ${{ matrix.python-architecture || 'x64' }}

      - name: Install OpenSSL development headers (Ubuntu)
        if: matrix.os == 'linux'
        run: |
          if command -v apt-get > /dev/null; then
            sudo apt-get update
            sudo apt-get install -y libssl-dev
          elif command -v yum > /dev/null; then
            yum install -y openssl-devel openssl-static
          fi

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos'
        run: |
          brew install openssl@3 sqlcipher pkg-config
          echo "OPENSSL_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$(brew --prefix openssl@3)/lib/pkgconfig:$(brew --prefix sqlcipher)/lib/pkgconfig" >> $GITHUB_ENV
          # Explicitly tell Rust linker where to find sqlcipher
          echo "RUSTFLAGS=-L $(brew --prefix sqlcipher)/lib" >> $GITHUB_ENV

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows'
        shell: pwsh
        run: |
          # Check if vcpkg exists and clean it if needed
          if (Test-Path "C:\vcpkg") {
            Remove-Item -Path "C:\vcpkg" -Recurse -Force
          }
          
          # Install vcpkg and build dependencies
          git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
          cd C:\vcpkg
          .\bootstrap-vcpkg.bat
          .\vcpkg integrate install
          
          # Install OpenSSL and SQLite3 (sqlcipher might not be available)
          .\vcpkg install openssl:x64-windows-static sqlite3:x64-windows-static
          
          # Try to install sqlcipher, but if it fails, we'll build from source
          $sqlcipherInstalled = $false
          try {
            .\vcpkg install sqlcipher:x64-windows-static
            $sqlcipherInstalled = $true
          } catch {
            Write-Host "SQLCipher not available in vcpkg, will build from source"
          }
          
          if (-not $sqlcipherInstalled) {
            # Build SQLCipher from source
            Write-Host "Building SQLCipher from source..."
            cd C:\
            
            # Download and extract SQLCipher
            Invoke-WebRequest -Uri "https://github.com/sqlcipher/sqlcipher/archive/refs/tags/v4.6.1.zip" -OutFile "sqlcipher.zip"
            Expand-Archive -Path "sqlcipher.zip" -DestinationPath "."
            cd sqlcipher-4.6.1
            
            # Use nmake to build (Windows equivalent)
            # This is complex on Windows, so let's use a prebuilt alternative
            Write-Host "Using sqlite3 as fallback (SQLCipher build on Windows is complex)"
            $env:SQLCIPHER_LIB_DIR = "C:\vcpkg\installed\x64-windows-static\lib"
            $env:SQLCIPHER_INCLUDE_DIR = "C:\vcpkg\installed\x64-windows-static\include"
          } else {
            $env:SQLCIPHER_LIB_DIR = "C:\vcpkg\installed\x64-windows-static\lib"
            $env:SQLCIPHER_INCLUDE_DIR = "C:\vcpkg\installed\x64-windows-static\include"
          }
          
          # Set environment variables
          echo "OPENSSL_DIR=C:\vcpkg\installed\x64-windows-static" >> $env:GITHUB_ENV
          echo "OPENSSL_LIB_DIR=C:\vcpkg\installed\x64-windows-static\lib" >> $env:GITHUB_ENV
          echo "OPENSSL_INCLUDE_DIR=C:\vcpkg\installed\x64-windows-static\include" >> $env:GITHUB_ENV
          echo "SQLCIPHER_LIB_DIR=C:\vcpkg\installed\x64-windows-static\lib" >> $env:GITHUB_ENV
          echo "SQLCIPHER_INCLUDE_DIR=C:\vcpkg\installed\x64-windows-static\include" >> $env:GITHUB_ENV
          echo "RUSTFLAGS=-L C:\vcpkg\installed\x64-windows-static\lib" >> $env:GITHUB_ENV
          echo "LIBSQLITE3_SYS_USE_PKG_CONFIG=1" >> $env:GITHUB_ENV
          
          # Verify the libraries exist
          if (Test-Path "C:\vcpkg\installed\x64-windows-static\lib") {
            Write-Host "Library directory found. Contents:"
            Get-ChildItem "C:\vcpkg\installed\x64-windows-static\lib" | Select-Object Name
          } else {
            Write-Host "Library directory not found!"
          }

      - run: pip install -U ruff typing_extensions

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.os == 'linux' && (matrix.target == 'aarch64' && 'aarch64-unknown-linux-gnu' || 'x86_64-unknown-linux-gnu') || matrix.os == 'macos' && (matrix.target == 'x86_64' && 'x86_64-apple-darwin' || 'aarch64-apple-darwin') || matrix.os == 'windows' && (matrix.target == 'aarch64' && 'aarch64-pc-windows-msvc' || 'x86_64-pc-windows-msvc') }}

      - name: Install maturin
        run: pip install maturin

      # =================== LINUX ===================
      - name: Build Linux wheels
        if: matrix.os == 'linux'
        run: |
          # Install build dependencies
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libssl-dev \
            curl \
            gcc \
            g++ \
            make \
            cmake \
            autoconf \
            automake \
            libtool
          
          # For x86_64/amd64, just use system libraries
          if [ "${{ matrix.target }}" = "x86_64" ] || [ "${{ matrix.target }}" = "amd64" ]; then
            # Install SQLCipher from source with system OpenSSL
            cd /tmp
            curl -fsSL https://github.com/sqlcipher/sqlcipher/archive/refs/tags/v4.6.1.tar.gz | tar xz
            cd sqlcipher-4.6.1
            
            CFLAGS="-DSQLITE_HAS_CODEC -fPIC" \
            CPPFLAGS="-fPIC" \
            LDFLAGS="-fPIC" \
            ./configure \
              --prefix=/usr/local \
              --enable-tempstore=yes \
              --enable-static=yes \
              --disable-shared \
              --with-crypto-lib=openssl \
              --with-pic
            
            make -j$(nproc)
            sudo make install
            
            cd ${{ github.workspace }}
            
            # Build wheels for x86_64/amd64
            for py in ${{ matrix.interpreter }}; do
              echo "Building for Python ${py}"
              OPENSSL_STATIC=1 maturin build --release --interpreter ${py}
            done
          else
            # Cross-compilation for aarch64
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu libc6-dev-arm64-cross
            export CC=aarch64-linux-gnu-gcc
            export CXX=aarch64-linux-gnu-g++
            export AR=aarch64-linux-gnu-ar
            export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
            RUST_TARGET="aarch64-unknown-linux-gnu"
            OPENSSL_TARGET="linux-aarch64"
            HOST_FLAG="--host=aarch64-linux-gnu"
            
            # Build OpenSSL for cross target
            PREFIX=/tmp/deps-${{ matrix.target }}
            mkdir -p "${PREFIX}"
            
            echo "Building OpenSSL 3.3.2 for ${{ matrix.target }}"
            cd /tmp
            curl -fsSL https://www.openssl.org/source/openssl-3.3.2.tar.gz | tar xz
            cd openssl-3.3.2
            
            ./Configure ${OPENSSL_TARGET} \
              --prefix="${PREFIX}" \
              --openssldir="${PREFIX}/ssl" \
              no-shared \
              no-async \
              -fPIC
            
            make -j$(nproc)
            make install_sw
            
            # Build SQLCipher for cross target
            echo "Building SQLCipher 4.6.1 for ${{ matrix.target }}"
            cd /tmp
            curl -fsSL https://github.com/sqlcipher/sqlcipher/archive/refs/tags/v4.6.1.tar.gz | tar xz
            cd sqlcipher-4.6.1
            
            CPPFLAGS="-I${PREFIX}/include" \
            LDFLAGS="-L${PREFIX}/lib" \
            LIBS="-lcrypto -lpthread" \
            ./configure \
              --prefix="${PREFIX}" \
              --enable-tempstore=yes \
              --enable-static=yes \
              --disable-shared \
              --with-crypto-lib=openssl \
              ${HOST_FLAG}
            
            make -j$(nproc)
            make install
            
            cd ${{ github.workspace }}
            
            # Export all the environment variables for cross-compilation
            export OPENSSL_DIR="${PREFIX}"
            export OPENSSL_STATIC=1
            export OPENSSL_LIB_DIR="${PREFIX}/lib"
            export OPENSSL_INCLUDE_DIR="${PREFIX}/include"
            export SQLCIPHER_LIB_DIR="${PREFIX}/lib"
            export SQLCIPHER_INCLUDE_DIR="${PREFIX}/include"
            export PKG_CONFIG_PATH="${PREFIX}/lib/pkgconfig"
            export PKG_CONFIG_ALLOW_CROSS=1
            
            # Build wheels for aarch64
            for py in ${{ matrix.interpreter }}; do
              echo "Building for Python ${py} on ${RUST_TARGET}"
              
              AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_DIR="${PREFIX}" \
              AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_STATIC=1 \
              AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_LIB_DIR="${PREFIX}/lib" \
              AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_INCLUDE_DIR="${PREFIX}/include" \
              maturin build --release --target ${RUST_TARGET} --interpreter ${py}
            done
          fi
          
          # Move all wheels to dist directory
          mkdir -p dist
          find target -name "*.whl" -exec mv {} dist/ \;

      # =================== MACOS ===================
      - name: Build macOS wheels
        if: matrix.os == 'macos'
        run: |
          # Dependencies already installed in earlier step
          # Build wheels for each Python version
          case "${{ matrix.target }}" in
            x86_64)
              RUST_TARGET="x86_64-apple-darwin"
              ;;
            aarch64)
              RUST_TARGET="aarch64-apple-darwin"
              ;;
          esac
          
          for py in ${{ matrix.interpreter }}; do
            echo "Building for Python ${py}"
            maturin build --release --target ${RUST_TARGET} --interpreter ${py}
          done
          
          # Move all wheels to dist directory
          mkdir -p dist
          find target -name "*.whl" -exec mv {} dist/ \;

      # =================== WINDOWS ===================  
      - name: Build Windows wheels
        if: matrix.os == 'windows'
        shell: pwsh
        run: |
          # Set environment variables for the build
          $env:OPENSSL_DIR = "C:\vcpkg\installed\x64-windows-static"
          $env:OPENSSL_LIB_DIR = "C:\vcpkg\installed\x64-windows-static\lib"
          $env:OPENSSL_INCLUDE_DIR = "C:\vcpkg\installed\x64-windows-static\include"
          $env:SQLCIPHER_LIB_DIR = "C:\vcpkg\installed\x64-windows-static\lib"
          $env:SQLCIPHER_INCLUDE_DIR = "C:\vcpkg\installed\x64-windows-static\include"
          $env:RUSTFLAGS = "-L C:\vcpkg\installed\x64-windows-static\lib"
          $env:OPENSSL_STATIC = "1"
          
          # Build wheels for each Python version
          switch ("${{ matrix.target }}") {
            "x86_64" {
              $rustTarget = "x86_64-pc-windows-msvc"
            }
            "aarch64" {
              $rustTarget = "aarch64-pc-windows-msvc"
            }
          }
          
          $pythonVersions = "${{ matrix.interpreter }}".Split()
          foreach ($py in $pythonVersions) {
            Write-Host "Building for Python $py"
            maturin build --release --target $rustTarget --interpreter $py
          }
          
          # Move all wheels to dist directory
          New-Item -ItemType Directory -Force -Path dist
          Get-ChildItem -Path target -Filter *.whl -Recurse | Move-Item -Destination dist

      - run: ${{ (matrix.os == 'windows' && 'dir') || 'ls -lh' }} dist/

      - uses: actions/upload-artifact@v4
        with:
          name: pypi_files_${{ matrix.os }}_${{ matrix.target }}_${{ matrix.interpreter || 'all' }}
          path: dist
