name: Build wheels

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: write

jobs:
  build:
    name: build on ${{ matrix.os }} (${{ matrix.target }} - ${{ matrix.interpreter || 'all' }})
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux builds - modern architectures only
          - os: linux
            target: amd64
            interpreter: 3.10 3.11 3.12 3.13
          - os: linux
            target: aarch64
            interpreter: 3.10 3.11 3.12 3.13

          # macOS builds
          - os: macos
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13
          - os: macos
            target: aarch64
            interpreter: 3.10 3.11 3.12 3.13

          # Windows builds
          - os: windows
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13 
          - os: windows
            target: aarch64
            runs-on: windows-11-arm
            interpreter: 3.11 3.12 3.13

    runs-on: ${{ matrix.runs-on || format('{0}-latest', (matrix.os == 'linux' && 'ubuntu') || matrix.os) }}
    steps:
      - uses: actions/checkout@v4

      - name: set up python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          architecture: ${{ matrix.python-architecture || 'x64' }}

      - name: Install OpenSSL development headers (Ubuntu)
        if: matrix.os == 'linux'
        run: |
          if command -v apt-get > /dev/null; then
            sudo apt-get update
            sudo apt-get install -y libssl-dev
          elif command -v yum > /dev/null; then
            yum install -y openssl-devel openssl-static
          fi

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos'
        run: |
          brew install openssl@3 sqlcipher pkg-config
          echo "OPENSSL_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$(brew --prefix openssl@3)/lib/pkgconfig:$(brew --prefix sqlcipher)/lib/pkgconfig" >> $GITHUB_ENV
          # Explicitly tell Rust linker where to find sqlcipher
          echo "RUSTFLAGS=-L $(brew --prefix sqlcipher)/lib" >> $GITHUB_ENV

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows'
        shell: pwsh
        run: |
          # Determine architecture
          $arch = if ("${{ matrix.target }}" -eq "aarch64") { "arm64" } else { "x64" }
          $vcpkgTriplet = "${arch}-windows-static"
          
          # Check if vcpkg exists and clean it if needed
          if (Test-Path "C:\vcpkg") {
            Remove-Item -Path "C:\vcpkg" -Recurse -Force
          }
          
          # Install vcpkg and build dependencies
          git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
          cd C:\vcpkg
          .\bootstrap-vcpkg.bat
          .\vcpkg integrate install
          
          # Install OpenSSL and SQLite3 for the correct architecture
          Write-Host "Installing packages for $vcpkgTriplet"
          .\vcpkg install "openssl:$vcpkgTriplet" "sqlite3:$vcpkgTriplet"
          
          # Set environment variables for the correct architecture
          $installPath = "C:\vcpkg\installed\$vcpkgTriplet"
          
          echo "OPENSSL_DIR=$installPath" >> $env:GITHUB_ENV
          echo "OPENSSL_LIB_DIR=$installPath\lib" >> $env:GITHUB_ENV
          echo "OPENSSL_INCLUDE_DIR=$installPath\include" >> $env:GITHUB_ENV
          echo "SQLCIPHER_LIB_DIR=$installPath\lib" >> $env:GITHUB_ENV
          echo "SQLCIPHER_INCLUDE_DIR=$installPath\include" >> $env:GITHUB_ENV
          echo "SQLITE3_LIB_DIR=$installPath\lib" >> $env:GITHUB_ENV
          # Export RUSTFLAGS including explicit link args for MSVC linker to bring in OpenSSL
          echo "RUSTFLAGS=-L $installPath\lib -C link-arg=libcrypto.lib -C link-arg=libssl.lib" >> $env:GITHUB_ENV
          echo "OPENSSL_STATIC=1" >> $env:GITHUB_ENV
          
          # For ARM64, we need to use the bundled SQLite since cross-compilation is complex
          if ("${{ matrix.target }}" -eq "aarch64") {
            echo "LIBSQLITE3_SYS_USE_BUNDLED=1" >> $env:GITHUB_ENV
            Write-Host "Using bundled SQLite for ARM64"
          } else {
            echo "LIBSQLITE3_SYS_USE_PKG_CONFIG=1" >> $env:GITHUB_ENV
          }
          
          # Verify the libraries exist
          if (Test-Path "$installPath\lib") {
            Write-Host "Library directory found. Contents:"
            Get-ChildItem "$installPath\lib" | Select-Object Name
          } else {
            Write-Host "Library directory not found!"
          }

          # If sqlcipher.lib is missing but sqlite3.lib exists, create a copy as a fallback
          if (-not (Test-Path "$installPath\lib\sqlcipher.lib")) {
            if (Test-Path "$installPath\lib\sqlite3.lib") {
              Write-Host "sqlcipher.lib missing — creating from sqlite3.lib as fallback"
              Copy-Item "$installPath\lib\sqlite3.lib" "$installPath\lib\sqlcipher.lib" -Force
              Write-Host "Created $installPath\lib\sqlcipher.lib"
            } else {
              Write-Host "Neither sqlcipher.lib nor sqlite3.lib found in $installPath\lib"
            }
          } else {
            Write-Host "sqlcipher.lib already present"
          }

          # Export LIB so MSVC link.exe can find vcpkg libs
          echo "LIB=$installPath\lib" >> $env:GITHUB_ENV
          
      - run: pip install -U ruff typing_extensions setuptools

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.os == 'linux' && (matrix.target == 'aarch64' && 'aarch64-unknown-linux-gnu' || 'x86_64-unknown-linux-gnu') || matrix.os == 'macos' && (matrix.target == 'x86_64' && 'x86_64-apple-darwin' || 'aarch64-apple-darwin') || matrix.os == 'windows' && (matrix.target == 'aarch64' && 'aarch64-pc-windows-msvc' || 'x86_64-pc-windows-msvc') }}

      - name: Install maturin
        run: pip install maturin

      # =================== LINUX ===================
      - name: Build Linux wheels
        if: matrix.os == 'linux'
        run: |
          # Install build dependencies
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libssl-dev \
            curl \
            gcc \
            g++ \
            make \
            cmake \
            autoconf \
            automake \
            libtool
          
          # For x86_64/amd64, just use system libraries
          if [ "${{ matrix.target }}" = "x86_64" ] || [ "${{ matrix.target }}" = "amd64" ]; then
            # Install SQLCipher from source with system OpenSSL
            cd /tmp
            curl -fsSL https://github.com/sqlcipher/sqlcipher/archive/refs/tags/v4.6.1.tar.gz | tar xz
            cd sqlcipher-4.6.1
            
            CFLAGS="-DSQLITE_HAS_CODEC -fPIC" \
            CPPFLAGS="-fPIC" \
            LDFLAGS="-fPIC" \
            ./configure \
              --prefix=/usr/local \
              --enable-tempstore=yes \
              --enable-static=yes \
              --disable-shared \
              --with-crypto-lib=openssl \
              --with-pic
            
            make -j$(nproc)
            sudo make install
            
            cd ${{ github.workspace }}
            
            # Build wheels for x86_64/amd64
            for py in ${{ matrix.interpreter }}; do
              echo "Building for Python ${py}"
              OPENSSL_STATIC=1 maturin build --release --interpreter ${py}
            done
          else
            # Cross-compilation for aarch64
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu libc6-dev-arm64-cross
            export CC=aarch64-linux-gnu-gcc
            export CXX=aarch64-linux-gnu-g++
            export AR=aarch64-linux-gnu-ar
            export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
            RUST_TARGET="aarch64-unknown-linux-gnu"
            OPENSSL_TARGET="linux-aarch64"
            HOST_FLAG="--host=aarch64-linux-gnu"
            
            # Build OpenSSL for cross target
            PREFIX=/tmp/deps-${{ matrix.target }}
            mkdir -p "${PREFIX}"
            
            echo "Building OpenSSL 3.3.2 for ${{ matrix.target }}"
            cd /tmp
            curl -fsSL https://www.openssl.org/source/openssl-3.3.2.tar.gz | tar xz
            cd openssl-3.3.2
            
            ./Configure ${OPENSSL_TARGET} \
              --prefix="${PREFIX}" \
              --openssldir="${PREFIX}/ssl" \
              no-shared \
              no-async \
              -fPIC
            
            make -j$(nproc)
            make install_sw
            
            # Build SQLCipher for cross target
            echo "Building SQLCipher 4.6.1 for ${{ matrix.target }}"
            cd /tmp
            curl -fsSL https://github.com/sqlcipher/sqlcipher/archive/refs/tags/v4.6.1.tar.gz | tar xz
            cd sqlcipher-4.6.1
            
            CPPFLAGS="-I${PREFIX}/include" \
            LDFLAGS="-L${PREFIX}/lib" \
            LIBS="-lcrypto -lpthread" \
            ./configure \
              --prefix="${PREFIX}" \
              --enable-tempstore=yes \
              --enable-static=yes \
              --disable-shared \
              --with-crypto-lib=openssl \
              ${HOST_FLAG}
            
            make -j$(nproc)
            make install
            
            cd ${{ github.workspace }}
            
            # Export all the environment variables for cross-compilation
            export OPENSSL_DIR="${PREFIX}"
            export OPENSSL_STATIC=1
            export OPENSSL_LIB_DIR="${PREFIX}/lib"
            export OPENSSL_INCLUDE_DIR="${PREFIX}/include"
            export SQLCIPHER_LIB_DIR="${PREFIX}/lib"
            export SQLCIPHER_INCLUDE_DIR="${PREFIX}/include"
            export PKG_CONFIG_PATH="${PREFIX}/lib/pkgconfig"
            export PKG_CONFIG_ALLOW_CROSS=1
            
            # Build wheels for aarch64
            for py in ${{ matrix.interpreter }}; do
              echo "Building for Python ${py} on ${RUST_TARGET}"
              
              AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_DIR="${PREFIX}" \
              AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_STATIC=1 \
              AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_LIB_DIR="${PREFIX}/lib" \
              AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_INCLUDE_DIR="${PREFIX}/include" \
              maturin build --release --target ${RUST_TARGET} --interpreter ${py}
            done
          fi
          
          # Move all wheels to dist directory
          mkdir -p dist
          find target -name "*.whl" -exec mv {} dist/ \;

      # =================== MACOS ===================
      - name: Build macOS wheels
        if: matrix.os == 'macos'
        run: |
          # Dependencies already installed in earlier step
          # Build wheels for each Python version
          case "${{ matrix.target }}" in
            x86_64)
              RUST_TARGET="x86_64-apple-darwin"
              ;;
            aarch64)
              RUST_TARGET="aarch64-apple-darwin"
              ;;
          esac
          
          for py in ${{ matrix.interpreter }}; do
            echo "Building for Python ${py}"
            maturin build --release --target ${RUST_TARGET} --interpreter ${py}
          done
          
          # Move all wheels to dist directory
          mkdir -p dist
          find target -name "*.whl" -exec mv {} dist/ \;

      # =================== WINDOWS ===================  
      - name: Build Windows wheels
        if: matrix.os == 'windows'
        shell: pwsh
        run: |
          # Determine architecture paths
          $arch = if ("${{ matrix.target }}" -eq "aarch64") { "arm64" } else { "x64" }
          $vcpkgTriplet = "${arch}-windows-static"
          $installPath = "C:\vcpkg\installed\$vcpkgTriplet"
          
          # Set environment variables for the build (ensure linker finds OpenSSL and sqlcipher)
          $env:OPENSSL_DIR = $installPath
          $env:OPENSSL_LIB_DIR = "$installPath\lib"
          $env:OPENSSL_INCLUDE_DIR = "$installPath\include"
          $env:SQLCIPHER_LIB_DIR = "$installPath\lib"
          $env:SQLCIPHER_INCLUDE_DIR = "$installPath\include"
          $env:SQLITE3_LIB_DIR = "$installPath\lib"
          # ensure rustc/cargo pass the OpenSSL libs to the MSVC linker
          $env:RUSTFLAGS = "-L $installPath\lib -C link-arg=libcrypto.lib -C link-arg=libssl.lib"
          # also set LIB so link.exe will search the directory (runtime)
          $env:LIB = "$installPath\lib;$env:LIB"
          $env:OPENSSL_STATIC = "1"

          # Confirm sqlcipher.lib exists (helpful debug)
          if (Test-Path "$installPath\lib\sqlcipher.lib") {
            Write-Host "sqlcipher.lib found at $installPath\lib"
          } else {
            Write-Host "WARNING: sqlcipher.lib not found at $installPath\lib — link may fail"
          }
          
          # Build wheels for each Python version
          switch ("${{ matrix.target }}") {
            "x86_64" {
              $rustTarget = "x86_64-pc-windows-msvc"
            }
            "aarch64" {
              $rustTarget = "aarch64-pc-windows-msvc"
            }
          }
          
          $pythonVersions = "${{ matrix.interpreter }}".Split()
          foreach ($py in $pythonVersions) {
            Write-Host "Building for Python $py on $rustTarget"
            maturin build --release --target $rustTarget --interpreter $py
          }
          
          # Move all wheels to dist directory
          New-Item -ItemType Directory -Force -Path dist
          Get-ChildItem -Path target -Filter *.whl -Recurse | Move-Item -Destination dist

      - run: ${{ (matrix.os == 'windows' && 'dir') || 'ls -lh' }} dist/

      - uses: actions/upload-artifact@v4
        with:
          name: pypi_files_${{ matrix.os }}_${{ matrix.target }}_${{ matrix.interpreter || 'all' }}
          path: dist

  # =================== COLLECT AND PACKAGE ===================
  collect-and-package:
    name: Collect wheels and create wheelhouse
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      
      - name: Install build tools
        run: |
          pip install build maturin setuptools wheel
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
          pattern: pypi_files_*
      
      - name: Create wheelhouse and process files
        run: |
          # Create wheelhouse directory
          mkdir -p wheelhouse
          
          # Collect all wheel files
          find all-artifacts -name "*.whl" -exec cp {} wheelhouse/ \;
          
          # Build source distribution (tar.gz)
          echo "Building source distribution..."
          python -m build --sdist --outdir wheelhouse/
          
          # Generate SHA256 hashes for all files (avoid including CHECKSUMS.sha256 itself)
          cd wheelhouse
          echo "Generating hash signatures..."
          
          # Temporary file to accumulate sums
          TMP_SUMS="$(mktemp)"
          
          # Create per-file .sha256 and accumulate into TMP_SUMS
          for file in *.whl *.tar.gz; do
            if [ -f "$file" ]; then
              sha256sum "$file" >> "$TMP_SUMS"
              sha256sum "$file" > "$file.sha256"
              echo "Generated hash for $file"
            fi
          done
          
          # Atomically create the master CHECKSUMS.sha256 with a header, using the temp sums
          {
            echo "# SHA256 Checksums"
            echo "Generated on: $(date -u)"
            echo ""
            cat "$TMP_SUMS"
          } > CHECKSUMS.sha256
          
          # Cleanup
          rm -f "$TMP_SUMS"
          
          # Display summary
          echo "=================== Wheelhouse Contents ==================="
          ls -lh
          echo ""
          echo "=================== Checksums ==================="
          cat CHECKSUMS.sha256
      
      - name: Create requirements file for each platform
        run: |
          cd wheelhouse
          
          # Create platform-specific requirement files
          echo "# Linux AMD64/x86_64 Requirements" > requirements-linux-amd64.txt
          ls | grep -E "linux.*x86_64|linux.*amd64" | grep ".whl" >> requirements-linux-amd64.txt || true
          
          echo "# Linux ARM64/aarch64 Requirements" > requirements-linux-aarch64.txt
          ls | grep -E "linux.*aarch64" | grep ".whl" >> requirements-linux-aarch64.txt || true
          
          echo "# macOS x86_64 Requirements" > requirements-macos-x86_64.txt
          ls | grep -E "macosx.*x86_64" | grep ".whl" >> requirements-macos-x86_64.txt || true
          
          echo "# macOS ARM64 Requirements" > requirements-macos-arm64.txt
          ls | grep -E "macosx.*arm64|macosx.*universal2" | grep ".whl" >> requirements-macos-arm64.txt || true
          
          echo "# Windows AMD64 Requirements" > requirements-windows-amd64.txt
          ls | grep -E "win.*amd64" | grep ".whl" >> requirements-windows-amd64.txt || true
          
          echo "# Windows ARM64 Requirements" > requirements-windows-arm64.txt
          ls | grep -E "win.*arm64" | grep ".whl" >> requirements-windows-arm64.txt || true
      
      - name: Upload wheelhouse
        uses: actions/upload-artifact@v4
        with:
          name: wheelhouse
          path: wheelhouse/
          retention-days: 30
      
      - name: Create release archive
        run: |
          tar czf wheelhouse.tar.gz wheelhouse/
          zip -r wheelhouse.zip wheelhouse/
          
          # Generate hashes for archives
          sha256sum wheelhouse.tar.gz > wheelhouse.tar.gz.sha256
          sha256sum wheelhouse.zip > wheelhouse.zip.sha256
      
      - name: Upload release archives
        uses: actions/upload-artifact@v4
        with:
          name: release-archives
          path: |
            wheelhouse.tar.gz
            wheelhouse.tar.gz.sha256
            wheelhouse.zip
            wheelhouse.zip.sha256
          retention-days: 30
