name: Build wheels

on:
  workflow_dispatch:

jobs:
  build:
    name: build on ${{ matrix.os }} (${{ matrix.target }} - ${{ matrix.interpreter || 'all' }})
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux builds - simplified, no manylinux
          - os: linux
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13
          - os: linux
            target: aarch64
            interpreter: 3.10 3.11 3.12 3.13
          - os: linux
            target: armv7
            interpreter: 3.10 3.11 3.12 3.13

          # macOS builds - UNCHANGED
          - os: macos
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13
          - os: macos
            target: aarch64
            interpreter: 3.10 3.11 3.12 3.13

          # Windows builds - UNCHANGED
          - os: windows
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13 
          - os: windows
            target: aarch64
            runs-on: windows-11-arm
            interpreter: 3.11 3.12 3.13

    runs-on: ${{ matrix.runs-on || format('{0}-latest', (matrix.os == 'linux' && 'ubuntu') || matrix.os) }}
    steps:
      - uses: actions/checkout@v4

      - name: set up python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          architecture: ${{ matrix.python-architecture || 'x64' }}

      - name: Install OpenSSL development headers (Ubuntu)
        if: matrix.os == 'linux'
        run: |
          if command -v apt-get > /dev/null; then
            sudo apt-get update
            sudo apt-get install -y libssl-dev
          elif command -v yum > /dev/null; then
            yum install -y openssl-devel openssl-static
          fi

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos'
        run: |
          brew install openssl@3 sqlcipher pkg-config
          echo "OPENSSL_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$(brew --prefix openssl@3)/lib/pkgconfig:$(brew --prefix sqlcipher)/lib/pkgconfig" >> $GITHUB_ENV
          # Explicitly tell Rust linker where to find sqlcipher
          echo "RUSTFLAGS=-L $(brew --prefix sqlcipher)/lib" >> $GITHUB_ENV

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows'
        run: |
          vcpkg install openssl:x64-windows sqlcipher:x64-windows
          echo "OPENSSL_DIR=C:/vcpkg/installed/x64-windows" >> $GITHUB_ENV
          echo "SQLCIPHER_LIB_DIR=C:/vcpkg/installed/x64-windows/lib" >> $GITHUB_ENV
          echo "SQLCIPHER_INCLUDE_DIR=C:/vcpkg/installed/x64-windows/include" >> $GITHUB_ENV

      - run: pip install -U ruff typing_extensions

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.os == 'linux' && (matrix.target == 'aarch64' && 'aarch64-unknown-linux-gnu' || matrix.target == 'armv7' && 'armv7-unknown-linux-gnueabihf' || 'x86_64-unknown-linux-gnu') || matrix.os == 'macos' && (matrix.target == 'x86_64' && 'x86_64-apple-darwin' || 'aarch64-apple-darwin') || matrix.os == 'windows' && (matrix.target == 'aarch64' && 'aarch64-pc-windows-msvc' || 'x86_64-pc-windows-msvc') }}

      - name: Install maturin
        run: pip install maturin

      # =================== LINUX ===================
      - name: Build Linux wheels
        if: matrix.os == 'linux'
        run: |
          # Install build dependencies
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            curl \
            gcc \
            g++ \
            make \
            cmake \
            autoconf \
            automake \
            libtool
          
          # Install cross-compilation tools if needed
          case "${{ matrix.target }}" in
            aarch64)
              sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
              export CC=aarch64-linux-gnu-gcc
              export CXX=aarch64-linux-gnu-g++
              export AR=aarch64-linux-gnu-ar
              export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
              RUST_TARGET="aarch64-unknown-linux-gnu"
              ;;
            armv7)
              sudo apt-get install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf
              export CC=arm-linux-gnueabihf-gcc
              export CXX=arm-linux-gnueabihf-g++
              export AR=arm-linux-gnueabihf-ar
              export CARGO_TARGET_ARMV7_UNKNOWN_LINUX_GNUEABIHF_LINKER=arm-linux-gnueabihf-gcc
              RUST_TARGET="armv7-unknown-linux-gnueabihf"
              ;;
            x86_64)
              export CC=gcc
              export CXX=g++
              RUST_TARGET="x86_64-unknown-linux-gnu"
              ;;
          esac
          
          # Build OpenSSL
          PREFIX=/tmp/openssl-sqlcipher
          mkdir -p "${PREFIX}"
          
          echo "Building OpenSSL 3.3.2"
          cd /tmp
          curl -fsSL https://www.openssl.org/source/openssl-3.3.2.tar.gz | tar xz
          cd openssl-3.3.2
          
          case "${{ matrix.target }}" in
            x86_64)
              ./Configure linux-x86_64 --prefix="${PREFIX}" no-shared -fPIC
              ;;
            aarch64)
              CC=aarch64-linux-gnu-gcc ./Configure linux-aarch64 --prefix="${PREFIX}" no-shared -fPIC
              ;;
            armv7)
              CC=arm-linux-gnueabihf-gcc ./Configure linux-armv4 --prefix="${PREFIX}" no-shared -fPIC
              ;;
          esac
          
          make -j$(nproc)
          make install_sw
          
          # Build SQLCipher
          echo "Building SQLCipher 4.6.1"
          cd /tmp
          curl -fsSL https://github.com/sqlcipher/sqlcipher/archive/refs/tags/v4.6.1.tar.gz | tar xz
          cd sqlcipher-4.6.1
          
          CFLAGS="-I${PREFIX}/include -DSQLITE_HAS_CODEC" \
          LDFLAGS="-L${PREFIX}/lib" \
          ./configure \
            --prefix="${PREFIX}" \
            --enable-tempstore=yes \
            --enable-static=yes \
            --disable-shared \
            --with-crypto-lib=openssl \
            --host=${{ matrix.target == 'aarch64' && 'aarch64-linux-gnu' || matrix.target == 'armv7' && 'arm-linux-gnueabihf' || '' }}
          
          make -j$(nproc)
          make install
          
          cd ${{ github.workspace }}
          
          # Set environment variables
          export OPENSSL_DIR="${PREFIX}"
          export OPENSSL_STATIC=1
          export OPENSSL_LIB_DIR="${PREFIX}/lib"
          export OPENSSL_INCLUDE_DIR="${PREFIX}/include"
          export SQLCIPHER_LIB_DIR="${PREFIX}/lib"
          export SQLCIPHER_INCLUDE_DIR="${PREFIX}/include"
          export PKG_CONFIG_PATH="${PREFIX}/lib/pkgconfig:${PKG_CONFIG_PATH}"
          
          # Set target-specific OpenSSL variables
          case "${{ matrix.target }}" in
            x86_64)
              export X86_64_UNKNOWN_LINUX_GNU_OPENSSL_DIR="${PREFIX}"
              export X86_64_UNKNOWN_LINUX_GNU_OPENSSL_STATIC=1
              ;;
            aarch64)
              export AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_DIR="${PREFIX}"
              export AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_STATIC=1
              ;;
            armv7)
              export ARMV7_UNKNOWN_LINUX_GNUEABIHF_OPENSSL_DIR="${PREFIX}"
              export ARMV7_UNKNOWN_LINUX_GNUEABIHF_OPENSSL_STATIC=1
              ;;
          esac
          
          # Build wheels for each Python version
          for py in ${{ matrix.interpreter }}; do
            echo "Building for Python ${py}"
            maturin build --release --target ${RUST_TARGET} --interpreter ${py}
          done
          
          # Move all wheels to dist directory
          mkdir -p dist
          find target -name "*.whl" -exec mv {} dist/ \;
      - run: ${{ (matrix.os == 'windows' && 'dir') || 'ls -lh' }} dist/

      - uses: actions/upload-artifact@v4
        with:
          name: pypi_files_${{ matrix.os }}_${{ matrix.target }}_${{ matrix.interpreter || 'all' }}
          path: dist
