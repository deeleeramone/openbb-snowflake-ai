name: Build wheels

on:
  workflow_dispatch:

jobs:
  build:
    name: build on ${{ matrix.os }} (${{ matrix.target }} - ${{ matrix.interpreter || 'all' }})
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux builds - simplified, no manylinux
          - os: linux
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13
          - os: linux
            target: aarch64
            interpreter: 3.10 3.11 3.12 3.13
          - os: linux
            target: armv7
            interpreter: 3.10 3.11 3.12 3.13

          # macOS builds - UNCHANGED
          - os: macos
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13
          - os: macos
            target: aarch64
            interpreter: 3.10 3.11 3.12 3.13

          # Windows builds - UNCHANGED
          - os: windows
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13 
          - os: windows
            target: aarch64
            runs-on: windows-11-arm
            interpreter: 3.11 3.12 3.13

    runs-on: ${{ matrix.runs-on || format('{0}-latest', (matrix.os == 'linux' && 'ubuntu') || matrix.os) }}
    steps:
      - uses: actions/checkout@v4

      - name: set up python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          architecture: ${{ matrix.python-architecture || 'x64' }}

      - name: Install OpenSSL development headers (Ubuntu)
        if: matrix.os == 'linux'
        run: |
          if command -v apt-get > /dev/null; then
            sudo apt-get update
            sudo apt-get install -y libssl-dev
          elif command -v yum > /dev/null; then
            yum install -y openssl-devel openssl-static
          fi

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos'
        run: |
          brew install openssl@3 sqlcipher pkg-config
          echo "OPENSSL_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$(brew --prefix openssl@3)/lib/pkgconfig:$(brew --prefix sqlcipher)/lib/pkgconfig" >> $GITHUB_ENV
          # Explicitly tell Rust linker where to find sqlcipher
          echo "RUSTFLAGS=-L $(brew --prefix sqlcipher)/lib" >> $GITHUB_ENV

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows'
        run: |
          vcpkg install openssl:x64-windows sqlcipher:x64-windows
          echo "OPENSSL_DIR=C:/vcpkg/installed/x64-windows" >> $GITHUB_ENV
          echo "SQLCIPHER_LIB_DIR=C:/vcpkg/installed/x64-windows/lib" >> $GITHUB_ENV
          echo "SQLCIPHER_INCLUDE_DIR=C:/vcpkg/installed/x64-windows/include" >> $GITHUB_ENV

      - run: pip install -U ruff typing_extensions

      - name: build wheels
        uses: PyO3/maturin-action@v1
        env:
          # Workaround for ring crate build failure on aarch64
          CFLAGS_aarch64_unknown_linux_gnu: "-D__ARM_ARCH=8"
          # Workaround for ring crate build failure on armv7
          CFLAGS_armv7_unknown_linux_gnueabihf: "-D__ARM_ARCH=7"
          # Force static linking
          OPENSSL_STATIC: "1"
          SQLCIPHER_STATIC: "1"
        with:
          target: ${{ matrix.target == 'armv7' && 'armv7-unknown-linux-gnueabihf' || format('{0}-unknown-linux-gnu', matrix.target) }}
          args: --release --out dist --interpreter ${{ matrix.interpreter || '3.10 3.11 3.12 3.13' }} --compatibility linux
          rust-toolchain: stable
          manylinux: 'off'
          container: 'off'
          before-script-linux: |
            set -e
            set -x
            
            echo "=================== DIRECT BUILD - NO CONTAINERS ==================="
            echo "Building for target: ${{ matrix.target }}"
            
            # Install cross-compilation tools
            sudo apt-get update
            sudo apt-get install -y \
              build-essential \
              pkg-config \
              libssl-dev \
              libsqlcipher-dev \
              curl \
              gcc \
              g++ \
              make \
              cmake \
              autoconf \
              automake \
              libtool
            
            # Install cross-compilation toolchains for non-x86_64
            case "${{ matrix.target }}" in
              aarch64)
                sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
                export CC=aarch64-linux-gnu-gcc
                export CXX=aarch64-linux-gnu-g++
                export AR=aarch64-linux-gnu-ar
                export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
                ;;
              armv7)
                sudo apt-get install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf
                export CC=arm-linux-gnueabihf-gcc
                export CXX=arm-linux-gnueabihf-g++
                export AR=arm-linux-gnueabihf-ar
                export CARGO_TARGET_ARMV7_UNKNOWN_LINUX_GNUEABIHF_LINKER=arm-linux-gnueabihf-gcc
                ;;
              x86_64)
                export CC=gcc
                export CXX=g++
                ;;
            esac
            
            # Build and install OpenSSL for target
            PREFIX=/tmp/openssl-sqlcipher
            mkdir -p "${PREFIX}"
            
            echo "Building OpenSSL 3.3.2"
            cd /tmp
            curl -fsSL https://www.openssl.org/source/openssl-3.3.2.tar.gz | tar xz
            cd openssl-3.3.2
            
            case "${{ matrix.target }}" in
              x86_64)
                ./Configure linux-x86_64 --prefix="${PREFIX}" no-shared -fPIC
                ;;
              aarch64)
                CC=aarch64-linux-gnu-gcc ./Configure linux-aarch64 --prefix="${PREFIX}" no-shared -fPIC
                ;;
              armv7)
                CC=arm-linux-gnueabihf-gcc ./Configure linux-armv4 --prefix="${PREFIX}" no-shared -fPIC
                ;;
            esac
            
            make -j$(nproc)
            make install_sw
            
            # Build SQLCipher
            echo "Building SQLCipher 4.6.1"
            cd /tmp
            curl -fsSL https://github.com/sqlcipher/sqlcipher/archive/refs/tags/v4.6.1.tar.gz | tar xz
            cd sqlcipher-4.6.1
            
            CFLAGS="-I${PREFIX}/include -DSQLITE_HAS_CODEC" \
            LDFLAGS="-L${PREFIX}/lib" \
            ./configure \
              --prefix="${PREFIX}" \
              --enable-tempstore=yes \
              --enable-static=yes \
              --disable-shared \
              --with-crypto-lib=openssl \
              --host=${{ matrix.target == 'aarch64' && 'aarch64-linux-gnu' || matrix.target == 'armv7' && 'arm-linux-gnueabihf' || '' }}
            
            make -j$(nproc)
            make install
            
            # Set environment variables for Rust
            export OPENSSL_DIR="${PREFIX}"
            export OPENSSL_LIB_DIR="${PREFIX}/lib"
            export OPENSSL_INCLUDE_DIR="${PREFIX}/include"
            export SQLCIPHER_LIB_DIR="${PREFIX}/lib"
            export SQLCIPHER_INCLUDE_DIR="${PREFIX}/include"
            export PKG_CONFIG_PATH="${PREFIX}/lib/pkgconfig:${PKG_CONFIG_PATH}"
            
            # Target-specific exports
            case "${{ matrix.target }}" in
              x86_64)
                echo "X86_64_UNKNOWN_LINUX_GNU_OPENSSL_DIR=${PREFIX}" >> $GITHUB_ENV
                echo "X86_64_UNKNOWN_LINUX_GNU_OPENSSL_STATIC=1" >> $GITHUB_ENV
                ;;
              aarch64)
                echo "AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_DIR=${PREFIX}" >> $GITHUB_ENV
                echo "AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_STATIC=1" >> $GITHUB_ENV
                ;;
              armv7)
                echo "ARMV7_UNKNOWN_LINUX_GNUEABIHF_OPENSSL_DIR=${PREFIX}" >> $GITHUB_ENV
                echo "ARMV7_UNKNOWN_LINUX_GNUEABIHF_OPENSSL_STATIC=1" >> $GITHUB_ENV
                ;;
            esac
            
            # Export to GitHub env for maturin
            echo "OPENSSL_DIR=${PREFIX}" >> $GITHUB_ENV
            echo "OPENSSL_STATIC=1" >> $GITHUB_ENV
            echo "SQLCIPHER_LIB_DIR=${PREFIX}/lib" >> $GITHUB_ENV
            echo "SQLCIPHER_INCLUDE_DIR=${PREFIX}/include" >> $GITHUB_ENV
            echo "PKG_CONFIG_PATH=${PREFIX}/lib/pkgconfig:${PKG_CONFIG_PATH}" >> $GITHUB_ENV
            
            echo "=================== BUILD SETUP COMPLETE ==================="
      - run: ${{ (matrix.os == 'windows' && 'dir') || 'ls -lh' }} dist/

      - uses: actions/upload-artifact@v4
        with:
          name: pypi_files_${{ matrix.os }}_${{ matrix.target }}_${{ matrix.interpreter || 'all' }}
          path: dist
