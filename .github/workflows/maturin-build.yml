name: Build wheels

on:
  workflow_dispatch:

jobs:
  build:
    name: build on ${{ matrix.os }} (${{ matrix.target }} - ${{ matrix.interpreter || 'all' }})
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux builds - simplified, no manylinux
          - os: linux
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13
          - os: linux
            target: aarch64
            interpreter: 3.10 3.11 3.12 3.13
          - os: linux
            target: armv7
            interpreter: 3.10 3.11 3.12 3.13

          # macOS builds - UNCHANGED
          - os: macos
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13
          - os: macos
            target: aarch64
            interpreter: 3.10 3.11 3.12 3.13

          # Windows builds - UNCHANGED
          - os: windows
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13 
          - os: windows
            target: aarch64
            runs-on: windows-11-arm
            interpreter: 3.11 3.12 3.13

    runs-on: ${{ matrix.runs-on || format('{0}-latest', (matrix.os == 'linux' && 'ubuntu') || matrix.os) }}
    steps:
      - uses: actions/checkout@v4

      - name: set up python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          architecture: ${{ matrix.python-architecture || 'x64' }}

      - name: Install OpenSSL development headers (Ubuntu)
        if: matrix.os == 'linux'
        run: |
          if command -v apt-get > /dev/null; then
            sudo apt-get update
            sudo apt-get install -y libssl-dev
          elif command -v yum > /dev/null; then
            yum install -y openssl-devel openssl-static
          fi

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos'
        run: |
          brew install openssl@3 sqlcipher pkg-config
          echo "OPENSSL_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$(brew --prefix openssl@3)/lib/pkgconfig:$(brew --prefix sqlcipher)/lib/pkgconfig" >> $GITHUB_ENV
          # Explicitly tell Rust linker where to find sqlcipher
          echo "RUSTFLAGS=-L $(brew --prefix sqlcipher)/lib" >> $GITHUB_ENV

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows'
        run: |
          vcpkg install openssl:x64-windows sqlcipher:x64-windows
          echo "OPENSSL_DIR=C:/vcpkg/installed/x64-windows" >> $GITHUB_ENV
          echo "SQLCIPHER_LIB_DIR=C:/vcpkg/installed/x64-windows/lib" >> $GITHUB_ENV
          echo "SQLCIPHER_INCLUDE_DIR=C:/vcpkg/installed/x64-windows/include" >> $GITHUB_ENV

      - run: pip install -U ruff typing_extensions

      - name: build wheels
        uses: PyO3/maturin-action@v1
        env:
          # Workaround for ring crate build failure on aarch64
          CFLAGS_aarch64_unknown_linux_gnu: "-D__ARM_ARCH=8"
          # Workaround for ring crate build failure on armv7
          CFLAGS_armv7_unknown_linux_gnueabihf: "-D__ARM_ARCH=7"
        with:
          target: ${{ matrix.target }}
          args: --release --out dist --interpreter ${{ matrix.interpreter || '3.10 3.11 3.12 3.13' }}
          rust-toolchain: stable
          container: 'off'  # Disable default container
          before-script-linux: |
            # Only run this inside a container or with proper permissions
            if [ -f /.dockerenv ] || [ -n "${GITHUB_ACTIONS}" ]; then
              # If we're on GitHub Actions runner directly, we need sudo
              if [ -n "${GITHUB_ACTIONS}" ] && [ ! -f /.dockerenv ]; then
                echo "Running on GitHub Actions runner, using system packages"
                sudo apt-get update
                sudo apt-get install -y build-essential pkg-config libssl-dev libsqlcipher-dev
                
                # Set environment for system packages
                export OPENSSL_DIR=/usr
                export OPENSSL_STATIC=1
                export SQLCIPHER_LIB_DIR=/usr/lib/x86_64-linux-gnu
                export SQLCIPHER_INCLUDE_DIR=/usr/include
                export PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig
                
                # Target is from matrix
                TARGET="${{ matrix.target }}"
                case "${TARGET}" in
                  x86_64)
                    export X86_64_UNKNOWN_LINUX_GNU_OPENSSL_DIR=/usr
                    export X86_64_UNKNOWN_LINUX_GNU_OPENSSL_STATIC=1
                    ;;
                  aarch64)
                    export AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_DIR=/usr
                    export AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_STATIC=1
                    ;;
                  armv7)
                    export ARMV7_UNKNOWN_LINUX_GNUEABIHF_OPENSSL_DIR=/usr
                    export ARMV7_UNKNOWN_LINUX_GNUEABIHF_OPENSSL_STATIC=1
                    ;;
                esac
              else
                # Inside Docker container - build from source
                set -e
                set -x
                
                ORIGINAL_DIR=$(pwd)
                echo "=================== BUILD SETUP (CONTAINER) ==================="
                echo "TARGET=${{ matrix.target }}"
                echo "PWD=$(pwd)"
                
                # Install base build tools (no sudo needed in container)
                if command -v apt-get > /dev/null; then
                  apt-get update
                  apt-get install -y build-essential pkg-config curl ca-certificates tcl autoconf automake libtool
                elif command -v apk > /dev/null; then
                  apk update
                  apk add --no-cache build-base pkgconfig curl ca-certificates tcl autoconf automake libtool perl make
                elif command -v yum > /dev/null; then
                  yum install -y gcc gcc-c++ make perl-core pkgconfig curl tcl autoconf automake libtool
                fi
                
                # Set installation prefix
                PREFIX=/opt/deps
                mkdir -p "${PREFIX}"
                
                # Build OpenSSL
                echo "=================== BUILDING OPENSSL ==================="
                OPENSSL_VERSION=3.3.2
                OPENSSL_BUILD_DIR=$(mktemp -d)
                
                curl -fsSL "https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz" | tar -xz -C "${OPENSSL_BUILD_DIR}"
                cd "${OPENSSL_BUILD_DIR}/openssl-${OPENSSL_VERSION}"
                
                # Configure OpenSSL based on target
                case "${{ matrix.target }}" in
                  x86_64)
                    OPENSSL_TARGET=linux-x86_64
                    ;;
                  aarch64)
                    OPENSSL_TARGET=linux-aarch64
                    ;;
                  armv7)
                    OPENSSL_TARGET=linux-armv4
                    ;;
                  *)
                    OPENSSL_TARGET=linux-x86_64
                    ;;
                esac
                
                ./Configure \
                  "${OPENSSL_TARGET}" \
                  --prefix="${PREFIX}" \
                  --openssldir="${PREFIX}/ssl" \
                  no-shared \
                  no-async \
                  -fPIC
                
                make -j"$(nproc)"
                make install_sw
                cd "${ORIGINAL_DIR}"
                rm -rf "${OPENSSL_BUILD_DIR}"
                
                # Build SQLCipher
                echo "=================== BUILDING SQLCIPHER ==================="
                SQLCIPHER_VERSION=4.5.6
                SQLCIPHER_BUILD_DIR=$(mktemp -d)
                
                curl -fsSL "https://github.com/sqlcipher/sqlcipher/archive/refs/tags/v${SQLCIPHER_VERSION}.tar.gz" | tar -xz -C "${SQLCIPHER_BUILD_DIR}"
                cd "${SQLCIPHER_BUILD_DIR}/sqlcipher-${SQLCIPHER_VERSION}"
                
                # Configure SQLCipher with static OpenSSL
                CFLAGS="-I${PREFIX}/include -DSQLITE_HAS_CODEC" \
                LDFLAGS="-L${PREFIX}/lib" \
                LIBS="${PREFIX}/lib/libcrypto.a -lpthread" \
                ./configure \
                  --prefix="${PREFIX}" \
                  --enable-tempstore=yes \
                  --disable-tcl \
                  --disable-shared \
                  --enable-static \
                  --with-crypto-lib=openssl \
                  --enable-fts5
                
                make -j"$(nproc)"
                make install
                cd "${ORIGINAL_DIR}"
                rm -rf "${SQLCIPHER_BUILD_DIR}"
                
                # Export environment variables for Rust
                echo "=================== SETTING ENVIRONMENT ==================="
                export OPENSSL_DIR="${PREFIX}"
                export OPENSSL_STATIC=1
                export OPENSSL_LIB_DIR="${PREFIX}/lib"
                export OPENSSL_INCLUDE_DIR="${PREFIX}/include"
                export SQLCIPHER_LIB_DIR="${PREFIX}/lib"
                export SQLCIPHER_INCLUDE_DIR="${PREFIX}/include"
                export PKG_CONFIG_PATH="${PREFIX}/lib/pkgconfig"
                export PKG_CONFIG_ALLOW_CROSS=1
                
                # Set target-specific environment variables
                case "${{ matrix.target }}" in
                  x86_64)
                    export X86_64_UNKNOWN_LINUX_GNU_OPENSSL_DIR="${PREFIX}"
                    export X86_64_UNKNOWN_LINUX_GNU_OPENSSL_STATIC=1
                    ;;
                  aarch64)
                    export AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_DIR="${PREFIX}"
                    export AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_STATIC=1
                    ;;
                  armv7)
                    export ARMV7_UNKNOWN_LINUX_GNUEABIHF_OPENSSL_DIR="${PREFIX}"
                    export ARMV7_UNKNOWN_LINUX_GNUEABIHF_OPENSSL_STATIC=1
                    ;;
                esac
                
                # Set common flags
                export RUSTFLAGS="${RUSTFLAGS:-} -L${PREFIX}/lib"
                export LD_LIBRARY_PATH="${PREFIX}/lib:${LD_LIBRARY_PATH:-}"
                export LIBRARY_PATH="${PREFIX}/lib:${LIBRARY_PATH:-}"
                
                # Verify installation
                echo "=================== VERIFICATION ==================="
                echo "Checking OpenSSL installation:"
                if [ -f "${PREFIX}/include/openssl/opensslv.h" ]; then
                  echo "✓ OpenSSL headers found at ${PREFIX}/include"
                else
                  echo "✗ OpenSSL headers missing!"
                  exit 1
                fi
                
                if [ -f "${PREFIX}/lib/libcrypto.a" ]; then
                  echo "✓ OpenSSL libcrypto.a found at ${PREFIX}/lib"
                else
                  echo "✗ OpenSSL libcrypto.a missing!"
                  exit 1
                fi
                
                echo "Checking SQLCipher installation:"
                if [ -f "${PREFIX}/lib/libsqlcipher.a" ]; then
                  echo "✓ SQLCipher library found at ${PREFIX}/lib"
                else
                  echo "✗ SQLCipher library missing!"
                  exit 1
                fi
                
                echo "Environment variables set:"
                echo "OPENSSL_DIR=${OPENSSL_DIR}"
                echo "OPENSSL_LIB_DIR=${OPENSSL_LIB_DIR}"
                echo "OPENSSL_INCLUDE_DIR=${OPENSSL_INCLUDE_DIR}"
                echo "SQLCIPHER_LIB_DIR=${SQLCIPHER_LIB_DIR}"
                echo "PKG_CONFIG_PATH=${PKG_CONFIG_PATH}"
                echo "RUSTFLAGS=${RUSTFLAGS}"
                echo "=================== SETUP COMPLETE ==================="
      - run: ${{ (matrix.os == 'windows' && 'dir') || 'ls -lh' }} dist/

      - uses: actions/upload-artifact@v4
        with:
          name: pypi_files_${{ matrix.os }}_${{ matrix.target }}_${{ matrix.interpreter || 'all' }}
          path: dist
