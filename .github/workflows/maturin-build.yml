name: Build wheels

on:
  workflow_dispatch:

jobs:
  build:
    name: build on ${{ matrix.os }} (${{ matrix.target }} - ${{ matrix.interpreter || 'all' }}${{ matrix.os == 'linux' && format(' - {0}', matrix.manylinux == 'auto' && 'manylinux' || matrix.manylinux) || '' }})
    strategy:
      fail-fast: false
      matrix:
        os: [linux, macos, windows]
        target: [undefined]
        manylinux: [auto]
        include:
          # manylinux for various platforms
          # x86_64 and aarch64 are PGO optimized below
          - os: linux
            manylinux: auto
            target: i686
          - os: linux
            manylinux: auto
            target: armv7
            interpreter: 3.10 3.11 3.12 3.13 
          - os: linux
            manylinux: auto
            target: ppc64le
            interpreter: 3.10 3.11 3.12 3.13 
          - os: linux
            manylinux: auto
            target: s390x
            interpreter: 3.10 3.11 3.12 3.13 
          - os: linux
            manylinux: auto
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13
          - os: linux
            manylinux: auto
            target: aarch64
            interpreter: 3.10 3.11 3.12 3.13

          # musllinux
          - os: linux
            manylinux: musllinux_1_1
            target: x86_64
          - os: linux
            manylinux: musllinux_1_1
            target: aarch64
          - os: linux
            manylinux: musllinux_1_1
            target: armv7

          - os: macos
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13
          - os: macos
            target: aarch64
            interpreter: 3.10 3.11 3.12 3.13

          - os: windows
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13 
          - os: windows
            target: aarch64
            runs-on: windows-11-arm
            interpreter: 3.11 3.12 3.13

        exclude:
          # was just a dummy variable to set a default value for target
          - target: undefined

    runs-on: ${{ matrix.runs-on || format('{0}-latest', (matrix.os == 'linux' && 'ubuntu') || matrix.os) }}
    steps:
      - uses: actions/checkout@v4

      - name: set up python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          architecture: ${{ matrix.python-architecture || 'x64' }}

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos'
        run: |
          brew install openssl@3 sqlcipher pkg-config
          echo "OPENSSL_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$(brew --prefix openssl@3)/lib/pkgconfig:$(brew --prefix sqlcipher)/lib/pkgconfig" >> $GITHUB_ENV
          # Explicitly tell Rust linker where to find sqlcipher
          echo "RUSTFLAGS=-L $(brew --prefix sqlcipher)/lib" >> $GITHUB_ENV

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows'
        run: |
          vcpkg install openssl:x64-windows sqlcipher:x64-windows
          echo "OPENSSL_DIR=C:/vcpkg/installed/x64-windows" >> $GITHUB_ENV
          echo "SQLCIPHER_LIB_DIR=C:/vcpkg/installed/x64-windows/lib" >> $GITHUB_ENV
          echo "SQLCIPHER_INCLUDE_DIR=C:/vcpkg/installed/x64-windows/include" >> $GITHUB_ENV

      - run: pip install -U ruff typing_extensions

      - name: build wheels
        uses: PyO3/maturin-action@v1
        env:
          # Workaround for ring crate build failure on aarch64
          CFLAGS_aarch64_unknown_linux_gnu: "-D__ARM_ARCH=8"
          CFLAGS_aarch64_unknown_linux_musl: "-D__ARM_ARCH=8"
          # Workaround for ring crate build failure on armv7
          CFLAGS_armv7_unknown_linux_gnueabihf: "-D__ARM_ARCH=7"
          CFLAGS_armv7_unknown_linux_musleabihf: "-D__ARM_ARCH=7"
        with:
          target: ${{ matrix.target }}
          manylinux: ${{ matrix.manylinux }}
          args: --release --out dist --interpreter ${{ matrix.interpreter || '3.10 3.11 3.12 3.13' }}
          rust-toolchain: stable
          docker-options: >-
            -e CI 
            -e TARGET=${{ matrix.target }}
            -e RUSTFLAGS=-L/usr/lib
            -e CFLAGS_aarch64_unknown_linux_gnu
            -e CFLAGS_aarch64_unknown_linux_musl
            -e CFLAGS_armv7_unknown_linux_gnueabihf
            -e CFLAGS_armv7_unknown_linux_musleabihf
            -e PKG_CONFIG_PATH=/usr/lib/pkgconfig:/usr/lib64/pkgconfig:/usr/share/pkgconfig:/usr/local/lib/pkgconfig:/usr/local/lib64/pkgconfig
            -e OPENSSL_DIR=/usr
            -e OPENSSL_LIB_DIR=/usr/lib
            -e OPENSSL_INCLUDE_DIR=/usr/include
            -e AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_DIR=/usr
            -e AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_LIB_DIR=/usr/lib
            -e AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_INCLUDE_DIR=/usr/include
            -e AARCH64_UNKNOWN_LINUX_MUSL_OPENSSL_DIR=/usr
            -e AARCH64_UNKNOWN_LINUX_MUSL_OPENSSL_LIB_DIR=/usr/lib
            -e AARCH64_UNKNOWN_LINUX_MUSL_OPENSSL_INCLUDE_DIR=/usr/include
            -e ARMV7_UNKNOWN_LINUX_GNUEABIHF_OPENSSL_DIR=/usr
            -e ARMV7_UNKNOWN_LINUX_GNUEABIHF_OPENSSL_LIB_DIR=/usr/lib
            -e ARMV7_UNKNOWN_LINUX_GNUEABIHF_OPENSSL_INCLUDE_DIR=/usr/include
            -e ARMV7_UNKNOWN_LINUX_MUSLEABIHF_OPENSSL_DIR=/usr
            -e ARMV7_UNKNOWN_LINUX_MUSLEABIHF_OPENSSL_LIB_DIR=/usr/lib
            -e ARMV7_UNKNOWN_LINUX_MUSLEABIHF_OPENSSL_INCLUDE_DIR=/usr/include
            -e S390X_UNKNOWN_LINUX_GNU_OPENSSL_DIR=/usr
            -e S390X_UNKNOWN_LINUX_GNU_OPENSSL_LIB_DIR=/usr/lib
            -e S390X_UNKNOWN_LINUX_GNU_OPENSSL_INCLUDE_DIR=/usr/include
            -e PPC64LE_UNKNOWN_LINUX_GNU_OPENSSL_DIR=/usr
            -e PPC64LE_UNKNOWN_LINUX_GNU_OPENSSL_LIB_DIR=/usr/lib
            -e PPC64LE_UNKNOWN_LINUX_GNU_OPENSSL_INCLUDE_DIR=/usr/include
            -e I686_UNKNOWN_LINUX_GNU_OPENSSL_DIR=/usr
            -e I686_UNKNOWN_LINUX_GNU_OPENSSL_LIB_DIR=/usr/lib
            -e I686_UNKNOWN_LINUX_GNU_OPENSSL_INCLUDE_DIR=/usr/include
            -e X86_64_UNKNOWN_LINUX_GNU_OPENSSL_DIR=/usr
            -e X86_64_UNKNOWN_LINUX_GNU_OPENSSL_LIB_DIR=/usr/lib
            -e X86_64_UNKNOWN_LINUX_GNU_OPENSSL_INCLUDE_DIR=/usr/include
            -e X86_64_UNKNOWN_LINUX_MUSL_OPENSSL_DIR=/usr
            -e X86_64_UNKNOWN_LINUX_MUSL_OPENSSL_LIB_DIR=/usr/lib
            -e X86_64_UNKNOWN_LINUX_MUSL_OPENSSL_INCLUDE_DIR=/usr/include
          before-script-linux: |
            set -e
            set -x
            
            # Install build tools and dependencies using system package managers
            if command -v apk > /dev/null; then
              # Alpine (musl)
              # sqlcipher is in the community repository
              echo "http://dl-cdn.alpinelinux.org/alpine/edge/community" >> /etc/apk/repositories
              echo "http://dl-cdn.alpinelinux.org/alpine/edge/main" >> /etc/apk/repositories
              apk update
              apk add pkgconfig perl make gcc musl-dev git openssl-dev tcl sqlcipher-dev
            elif command -v yum > /dev/null; then
              # CentOS/RHEL (manylinux2014)
              # sqlcipher might be in EPEL
              yum install -y epel-release || true
              yum install -y pkgconfig perl-core make gcc git openssl-devel tcl || true
              # Try to install sqlcipher-devel but don't fail if it's not available
              yum install -y sqlcipher-devel || echo "sqlcipher-devel not found in yum"
            elif command -v apt-get > /dev/null; then
              # Debian/Ubuntu
              apt-get update
              apt-get install -y pkg-config build-essential git libssl-dev tcl libsqlcipher-dev
            fi
            
            # Verify installation
            if pkg-config --exists sqlcipher; then
                echo "sqlcipher found via pkg-config"
            elif pkg-config --exists libsqlcipher; then
                 echo "libsqlcipher found via pkg-config"
            else
                 echo "WARNING: sqlcipher not found via pkg-config."
            fi
            
            # Debug: show where OpenSSL is installed
            echo "OpenSSL headers should be in:"
            ls -la /usr/include/openssl/ || echo "Not found in /usr/include/openssl/"
            echo "OpenSSL libraries should be in:"
            ls -la /usr/lib/*ssl* || echo "Not found in /usr/lib/"
            ls -la /usr/lib64/*ssl* || echo "Not found in /usr/lib64/"

      - run: ${{ (matrix.os == 'windows' && 'dir') || 'ls -lh' }} dist/

      - uses: actions/upload-artifact@v4
        with:
          name: pypi_files_${{ matrix.os }}_${{ matrix.target }}_${{ matrix.interpreter || 'all' }}_${{ matrix.manylinux }}
          path: dist
