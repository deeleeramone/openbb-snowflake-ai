name: Build wheels

on:
  workflow_dispatch:

jobs:
  build:
    name: build on ${{ matrix.os }} (${{ matrix.target }} - ${{ matrix.interpreter || 'all' }}${{ matrix.os == 'linux' && format(' - {0}', matrix.manylinux == 'auto' && 'manylinux' || matrix.manylinux) || '' }})
    strategy:
      fail-fast: false
      matrix:
        os: [linux, macos, windows]
        target: [undefined]
        manylinux: [auto]
        include:
          # manylinux for various platforms
          # x86_64 and aarch64 are PGO optimized below
          - os: linux
            manylinux: auto
            target: i686
          - os: linux
            manylinux: auto
            target: armv7
            interpreter: 3.10 3.11 3.12 3.13 
          - os: linux
            manylinux: auto
            target: ppc64le
            interpreter: 3.10 3.11 3.12 3.13 
          - os: linux
            manylinux: auto
            target: s390x
            interpreter: 3.10 3.11 3.12 3.13 
          - os: linux
            manylinux: auto
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13

            # manylinux pypy and graalpy on major architectures
          - os: linux
            manylinux: auto
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13
          - os: linux
            manylinux: auto
            target: aarch64
            interpreter: 3.10 3.11 3.12 3.13

          # musllinux
          - os: linux
            manylinux: musllinux_1_1
            target: x86_64
          - os: linux
            manylinux: musllinux_1_1
            target: aarch64
          - os: linux
            manylinux: musllinux_1_1
            target: armv7

          - os: macos
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13
          - os: macos
            target: aarch64
            interpreter: 3.10 3.11 3.12 3.13

          - os: windows
            target: x86_64
            interpreter: 3.10 3.11 3.12 3.13 
          - os: windows
            target: aarch64
            runs-on: windows-11-arm
            interpreter: 3.11 3.12 3.13

        exclude:
          # was just a dummy variable to set a default value for target
          - target: undefined

    runs-on: ${{ matrix.runs-on || format('{0}-latest', (matrix.os == 'linux' && 'ubuntu') || matrix.os) }}
    steps:
      - uses: actions/checkout@v4

      - name: set up python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          architecture: ${{ matrix.python-architecture || 'x64' }}

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos'
        run: |
          brew install openssl@3 sqlcipher pkg-config
          echo "OPENSSL_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$(brew --prefix openssl@3)/lib/pkgconfig:$(brew --prefix sqlcipher)/lib/pkgconfig" >> $GITHUB_ENV
          # Explicitly tell Rust linker where to find sqlcipher
          echo "RUSTFLAGS=-L $(brew --prefix sqlcipher)/lib" >> $GITHUB_ENV

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows'
        run: |
          vcpkg install openssl:x64-windows sqlcipher:x64-windows
          echo "OPENSSL_DIR=C:/vcpkg/installed/x64-windows" >> $GITHUB_ENV
          echo "SQLCIPHER_LIB_DIR=C:/vcpkg/installed/x64-windows/lib" >> $GITHUB_ENV
          echo "SQLCIPHER_INCLUDE_DIR=C:/vcpkg/installed/x64-windows/include" >> $GITHUB_ENV

      - run: pip install -U ruff typing_extensions

      - name: build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          manylinux: ${{ matrix.manylinux }}
          args: --release --out dist --interpreter ${{ matrix.interpreter || '3.10 3.11 3.12 3.13' }}
          rust-toolchain: stable
          docker-options: -e CI -e PKG_CONFIG_PATH=/usr/local/lib/pkgconfig
          before-script-linux: |
            if command -v apk > /dev/null; then
              apk add pkgconfig openssl-dev sqlcipher-dev
            elif command -v yum > /dev/null; then
              yum install -y openssl-devel
              # Build SQLCipher from source as it is not available in manylinux repos
              # Using Homebrew on Linux inside Docker is not recommended/standard for manylinux builds
              curl -L https://github.com/sqlcipher/sqlcipher/archive/v4.6.0.tar.gz -o sqlcipher.tar.gz
              tar xzf sqlcipher.tar.gz
              cd sqlcipher-4.6.0
              ./configure --enable-tempstore=yes --disable-tcl CFLAGS="-DSQLITE_HAS_CODEC"
              make
              make install
            elif command -v apt-get > /dev/null; then
              apt-get update && apt-get install -y pkg-config libssl-dev libsqlcipher-dev
            fi

      - run: ${{ (matrix.os == 'windows' && 'dir') || 'ls -lh' }} dist/

      - uses: actions/upload-artifact@v4
        with:
          name: pypi_files_${{ matrix.os }}_${{ matrix.target }}_${{ matrix.interpreter || 'all' }}_${{ matrix.manylinux }}
          path: dist
